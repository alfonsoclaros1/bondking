{% extends "base.html" %}
{% load humanize %}

{% block title %}Purchase Order Kanban{% endblock %}

{% block content %}
<div class="container-fluid py-3">

  <div class="d-flex justify-content-between align-items-center mb-3 flex-wrap gap-2">
    <div>
      <h2 class="mb-0">Purchase Order Kanban</h2>
      <small class="text-muted">
        Drag &amp; drop POs between stages. Yellow cards are pending approvals.
      </small>
    </div>

    <div class="d-flex align-items-center flex-wrap gap-3">
      <div class="d-flex align-items-center gap-2">
        <span class="badge bg-warning text-dark">&nbsp;</span>
        <small>Pending approval</small>
      </div>
      <div class="d-flex align-items-center gap-2">
        <span class="badge bg-danger">&nbsp;</span>
        <small>Declined / for clarification</small>
      </div>
      <a href="{% url 'po-table' %}" class="btn btn-outline-secondary btn-sm">
        View Table
      </a>
      <a href="{% url 'po-create' %}" class="btn btn-primary btn-sm">
        + New RFQ
      </a>
    </div>
  </div>

  {% if is_admin_like %}
  <div class="mb-3 d-flex align-items-center flex-wrap gap-2">
    <label for="sim-role" class="form-label mb-0 me-2">
      Simulate role (for this board only):
    </label>
    <select id="sim-role" class="form-select form-select-sm" style="max-width: 260px;">
      {% for value, label in available_roles %}
      <option value="{{ value }}">{{ label }}</option>
      {% endfor %}
    </select>
    <small class="text-muted">
      Top Management can preview moves/approvals as different roles.
    </small>
  </div>
  {% endif %}

  <div id="kanban-board" class="kanban-board">
    {% for col in columns_render %}
    <div class="kanban-column-wrapper">
      <div class="kanban-column" data-column="{{ col.key }}">
        <div class="kanban-column-header">
          <div class="d-flex justify-content-between align-items-center">
            <strong>{{ col.label }}</strong>
            <span class="badge bg-secondary" id="count-{{ col.key }}">
              {{ col.items|length }}
            </span>
          </div>
        </div>

        <div class="kanban-column-body" data-column="{{ col.key }}">
          {% if col.items %}
            {% for po in col.items %}
            <div
              class="kanban-card card mb-2
                {% if po.approval_status == 'PENDING' %}kanban-card-pending{% elif po.approval_status == 'DECLINED' %}kanban-card-declined{% endif %}"
              draggable="{% if po.approval_status != 'PENDING' %}true{% else %}false{% endif %}"
              data-po-id="{{ po.id }}"
              data-current-column="{{ col.key }}"
              data-approval-status="{{ po.approval_status }}"
              data-move-url="{% url 'po-move' po.id %}"
              data-approve-url="{% url 'po-approve' po.id %}"
              data-decline-url="{% url 'po-decline' po.id %}"
              data-archive-url="{% url 'po-archive' po.id %}"
            >
              <div class="card-body p-2">

                {% if po.approval_status == "PENDING" %}
                <div class="d-flex justify-content-start gap-1 mb-2 kanban-approval-buttons">
                  <button type="button" class="btn btn-success btn-sm btn-approve">✓</button>
                  <button type="button" class="btn btn-danger btn-sm btn-decline">✕</button>
                </div>
                {% elif col.key == "PO_FILING" %}
                  <div class="d-flex justify-content-start mb-2">
                    <button type="button" class="btn btn-outline-secondary btn-sm btn-archive">
                      Archive
                    </button>
                  </div>
                {% endif %}

                <div class="mb-1">
                  <div class="fw-semibold">
                    <a href="{% url 'po-edit' po.id %}" class="text-decoration-none text-reset">
                      {{ po.paid_to }}
                    </a>
                  </div>
                  <div class="text-muted small">
                    {% if po.po_number %}
                      {{ po.po_number }}
                    {% else %}
                      {{ po.rfq_number }}
                    {% endif %}
                  </div>
                </div>

                <div class="small mb-2">
                  <div>{{ po.date|date:"Y-m-d" }}</div>
                  <div>₱{{ po.total|floatformat:2 |intcomma }}</div>
                </div>

                <div class="d-flex flex-wrap gap-1">
                  <span class="badge rounded-pill bg-light border text-muted">
                    {{ po.prepared_by.get_full_name|default:po.prepared_by.username }}
                  </span>
                  {% if po.product_id_ref %}
                    <span class="badge bg-info text-dark">
                      {{ po.product_id_ref.code }}
                    </span>
                  {% endif %}
                </div>

              </div>
            </div>
            {% endfor %}
          {% else %}
            <div class="kanban-empty text-muted small">
              No POs here
            </div>
          {% endif %}
        </div>
      </div>
    </div>
    {% endfor %}
  </div>
</div>
{% endblock %}

{% block extra_css %}
<style>
  .kanban-board {
    display: flex;
    gap: 1rem;
    overflow-x: auto;
    padding-bottom: 0.5rem;
  }

  .kanban-column-wrapper {
    flex: 0 0 auto;
    min-width: 200px;
    max-width: 280px;
  }

  .kanban-column {
    background-color: #f8f9fa;
    border-radius: 0.75rem;
    border: 1px solid #dee2e6;
    display: flex;
    flex-direction: column;
    max-height: calc(100vh - 210px);
  }

  .kanban-column-header {
    padding: 0.5rem 0.75rem;
    border-bottom: 1px solid #dee2e6;
    background-color: #e9ecef;
    border-top-left-radius: 0.75rem;
    border-top-right-radius: 0.75rem;
  }

  .kanban-column-body {
    padding: 0.5rem;
    overflow-y: auto;
    flex: 1;
    transition: background-color 0.15s ease, box-shadow 0.15s ease;
  }

  .kanban-column-body.drop-allowed {
    background-color: #f8f9fc;
  }

  .kanban-column-body.drop-hover {
    background-color: #e2f0ff;
    box-shadow: inset 0 0 0 2px rgba(13, 110, 253, 0.4);
  }

  .kanban-card {
    cursor: grab;
    transition: box-shadow 0.15s ease, transform 0.15s ease, opacity 0.15s ease;
  }

  .kanban-card.dragging {
    opacity: 0.75;
    box-shadow: 0 0.5rem 1.25rem rgba(0, 0, 0, 0.25);
    transform: scale(1.02);
  }

  .kanban-card-pending {
    border-left: 4px solid #ffc107;
    background-color: #fff9e6;
  }

  .kanban-card-declined {
    border-left: 4px solid #dc3545;
    background-color: #fdeaea;
  }

  .kanban-empty {
    border: 1px dashed #ced4da;
    border-radius: 0.5rem;
    padding: 0.45rem 0.5rem;
    text-align: center;
  }

  @media (max-width: 768px) {
    .kanban-column-wrapper { min-width: 220px; }
  }
</style>
{% endblock %}

{% block extra_js %}
<script>
  (function () {
    const IS_ADMIN_LIKE = "{{ is_admin_like|yesno:'true,false' }}" === "true";
    const csrftoken = getCookie('csrftoken');

    let draggedCard = null;
    let currentSimRole = null;

    document.addEventListener('DOMContentLoaded', function () {
      initSimRole();
      initDragAndDrop();
      initApproveDecline();
      initArchiveButtons();
      recomputeCountsAndEmpty();
    });

    function getCookie(name) {
      let cookieValue = null;
      if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
          const cookie = cookies[i].trim();
          if (cookie.substring(0, name.length + 1) === (name + '=')) {
            cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
            break;
          }
        }
      }
      return cookieValue;
    }

    function initSimRole() {
      const select = document.getElementById('sim-role');
      if (!select) {
        currentSimRole = null;
        return;
      }

      const saved = localStorage.getItem('bondking_sim_role') || '';
      if (saved) {
        for (const opt of select.options) {
          if (opt.value === saved) {
            opt.selected = true;
            break;
          }
        }
        currentSimRole = saved;
      } else if (select.value) {
        currentSimRole = select.value;
      }

      select.addEventListener('change', function () {
        currentSimRole = this.value || null;
        localStorage.setItem('bondking_sim_role', currentSimRole || '');
      });
    }

    function initDragAndDrop() {
      const board = document.getElementById('kanban-board');
      if (!board) return;

      board.addEventListener('dragstart', function (e) {
        const card = e.target.closest('.kanban-card');
        if (!card) return;

        const approvalStatus = card.dataset.approvalStatus;
        if (approvalStatus === 'PENDING') {
          e.preventDefault();
          return;
        }

        draggedCard = card;
        card.classList.add('dragging');

        try {
          e.dataTransfer.effectAllowed = 'move';
          e.dataTransfer.setData('text/plain', card.dataset.poId || '');
        } catch (err) {}

        document.querySelectorAll('.kanban-column-body').forEach(col => {
          col.classList.add('drop-allowed');
        });
      });

      board.addEventListener('dragend', function (e) {
        const card = e.target.closest('.kanban-card');
        if (card) card.classList.remove('dragging');
        draggedCard = null;

        document.querySelectorAll('.kanban-column-body').forEach(col => {
          col.classList.remove('drop-allowed', 'drop-hover');
        });
      });

      document.querySelectorAll('.kanban-column-body').forEach(col => {
        col.addEventListener('dragover', function (e) {
          if (!draggedCard) return;
          e.preventDefault();
          this.classList.add('drop-hover');
        });

        col.addEventListener('dragleave', function () {
          this.classList.remove('drop-hover');
        });

        col.addEventListener('drop', function (e) {
          if (!draggedCard) return;
          e.preventDefault();
          this.classList.remove('drop-hover');

          const targetColumn = this.dataset.column;
          const moveUrl = draggedCard.dataset.moveUrl;
          if (!moveUrl || !targetColumn) return;

          const card = draggedCard;

          const formData = new FormData();
          formData.append('target_column', targetColumn);
          formData.append('notes', '');

          if (IS_ADMIN_LIKE && currentSimRole) {
            formData.append('sim_role', currentSimRole);
          }

          fetch(moveUrl, {
            method: 'POST',
            headers: { 'X-CSRFToken': csrftoken },
            body: formData
          })
          .then(response => {
            if (!response.ok) {
              return response.json().then(data => { throw new Error(data.error || 'Error moving PO.'); });
            }
            return response.json();
          })
          .then(data => {
            if (!data.ok) throw new Error(data.error || 'Error moving PO.');

            const newColumn = data.new_column;
            const approvalStatus = data.approval_status;

            this.appendChild(card);
            card.dataset.currentColumn = newColumn;
            refreshCardAppearance(card, approvalStatus);

            recomputeCountsAndEmpty();
          })
          .catch(err => alert(err.message));
        });
      });
    }

    function initApproveDecline() {
      document.addEventListener('click', function (e) {
        const approveBtn = e.target.closest('.btn-approve');
        const declineBtn = e.target.closest('.btn-decline');

        if (approveBtn) {
          e.preventDefault(); e.stopPropagation();
          const card = approveBtn.closest('.kanban-card');
          if (card) handleApprove(card);
          return;
        }

        if (declineBtn) {
          e.preventDefault(); e.stopPropagation();
          const card = declineBtn.closest('.kanban-card');
          if (card) handleDecline(card);
          return;
        }
      });
    }

    function handleApprove(card) {
      const url = card.dataset.approveUrl;
      if (!url) return;

      const currentColumn = card.dataset.currentColumn || '';
      const formData = new FormData();
      formData.append('notes', `Approved in ${currentColumn} as ${currentSimRole || 'actual role'}.`);

      if (IS_ADMIN_LIKE && currentSimRole) formData.append('sim_role', currentSimRole);

      fetch(url, { method: 'POST', headers: { 'X-CSRFToken': csrftoken }, body: formData })
      .then(r => r.ok ? r.json() : r.json().then(d => { throw new Error(d.error || 'Error approving PO.'); }))
      .then(data => {
        if (!data.ok) throw new Error(data.error || 'Error approving PO.');
        refreshCardAppearance(card, data.approval_status);
        recomputeCountsAndEmpty();
      })
      .catch(err => alert(err.message));
    }

    function handleDecline(card) {
      const url = card.dataset.declineUrl;
      if (!url) return;

      const currentColumn = card.dataset.currentColumn || '';
      const formData = new FormData();
      formData.append('notes', `Declined in ${currentColumn} as ${currentSimRole || 'actual role'}.`);

      if (IS_ADMIN_LIKE && currentSimRole) formData.append('sim_role', currentSimRole);

      fetch(url, { method: 'POST', headers: { 'X-CSRFToken': csrftoken }, body: formData })
      .then(r => r.ok ? r.json() : r.json().then(d => { throw new Error(d.error || 'Error declining PO.'); }))
      .then(data => {
        if (!data.ok) throw new Error(data.error || 'Error declining PO.');

        const newColumn = data.column;
        refreshCardAppearance(card, data.approval_status);

        if (newColumn) {
          const targetBody = document.querySelector('.kanban-column-body[data-column="' + newColumn + '"]');
          if (targetBody) {
            targetBody.appendChild(card);
            card.dataset.currentColumn = newColumn;
          }
        }

        recomputeCountsAndEmpty();
      })
      .catch(err => alert(err.message));
    }

    function initArchiveButtons() {
      document.addEventListener('click', function (e) {
        const btn = e.target.closest('.btn-archive');
        if (!btn) return;

        e.preventDefault();
        e.stopPropagation();

        const card = btn.closest('.kanban-card');
        if (!card) return;

        const archiveUrl = card.dataset.archiveUrl;
        if (!archiveUrl) return;

        if (!confirm('Archive this PO? It will be removed from the board.')) return;

        fetch(archiveUrl, {
          method: 'POST',
          headers: { 'X-CSRFToken': csrftoken },
          body: new FormData()
        })
        .then(r => r.ok ? r.json() : r.json().then(d => { throw new Error(d.error || 'Error archiving PO.'); }).catch(()=>{ throw new Error('Error archiving PO.'); }))
        .then(data => {
          if (!data.ok) throw new Error('Error archiving PO.');
          card.remove();
          recomputeCountsAndEmpty();
        })
        .catch(err => alert(err.message));
      });
    }

    function refreshCardAppearance(card, approvalStatus) {
      card.dataset.approvalStatus = approvalStatus;
      card.classList.remove('kanban-card-pending', 'kanban-card-declined');

      let btnRow = card.querySelector('.kanban-approval-buttons');

      if (approvalStatus === 'PENDING') {
        card.classList.add('kanban-card-pending');
        card.setAttribute('draggable', 'false');

        if (!btnRow) {
          btnRow = document.createElement('div');
          btnRow.className = 'd-flex justify-content-end gap-1 mb-2 kanban-approval-buttons';

          const approveBtn = document.createElement('button');
          approveBtn.type = 'button';
          approveBtn.className = 'btn btn-success btn-sm btn-approve';
          approveBtn.textContent = '✓';

          const declineBtn = document.createElement('button');
          declineBtn.type = 'button';
          declineBtn.className = 'btn btn-danger btn-sm btn-decline';
          declineBtn.textContent = '✕';

          btnRow.appendChild(approveBtn);
          btnRow.appendChild(declineBtn);

          const cardBody = card.querySelector('.card-body');
          if (cardBody) cardBody.insertBefore(btnRow, cardBody.firstChild);
        }
      } else {
        if (btnRow) btnRow.remove();
        card.setAttribute('draggable', 'true');

        if (approvalStatus === 'DECLINED') card.classList.add('kanban-card-declined');
      }
    }

    function recomputeCountsAndEmpty() {
      document.querySelectorAll('.kanban-column').forEach(col => {
        const key = col.dataset.column;
        const body = col.querySelector('.kanban-column-body');
        const cards = body.querySelectorAll('.kanban-card');
        const count = cards.length;

        const badge = document.getElementById('count-' + key);
        if (badge) badge.textContent = count;

        let emptyDiv = body.querySelector('.kanban-empty');
        if (count === 0) {
          if (!emptyDiv) {
            emptyDiv = document.createElement('div');
            emptyDiv.className = 'kanban-empty text-muted small';
            emptyDiv.textContent = 'No POs here';
            body.appendChild(emptyDiv);
          }
        } else if (emptyDiv) {
          emptyDiv.remove();
        }
      });
    }
  })();
</script>
{% endblock %}
