{% extends "base.html" %}
{% load form_extras %}
{% load static %}
{% load form_extras %}


{% block content %}
<style>
input[name$="-id"] {
  display: none;
}
/* ===== DR ITEMS LAYOUT FIXES ===== */
.dr-item-row td {
  vertical-align: middle;
}

.dr-item-row input,
.dr-item-row select {
  width: 100%;
}

.dr-item-row input[type="number"] {
  text-align: right;
}

/* Prevent horizontal scrollbar */
.table-responsive {
  overflow-x: hidden;
}
</style>

<div class="container py-4">
  <div class="d-flex justify-content-between align-items-center mb-3">
    <h2 class="mb-0">
      {% if is_create %}DR {% else %}DR {{ dr.dr_number }}{% endif %}
    </h2>
    <span class="badge bg-secondary text-uppercase">
      Stage: {{ stage }}
    </span>
    <div class="d-flex justify-content-between align-items-center mb-3">

      <!-- ‚óÄ PREVIOUS DR -->
      <div>
        {% if prev_dr %}
          <a href="{% url 'dr-edit' prev_dr.id %}{% if nav_querystring %}?{{ nav_querystring }}{% endif %}"
            class="btn btn-outline-secondary btn-sm m-4"
            title="Previous DR">
            prev
          </a>
        {% endif %}
      </div>

      <!-- NEXT DR ‚ñ∂ -->
      <div>
        {% if next_dr %}
          <a href="{% url 'dr-edit' next_dr.id %}{% if nav_querystring %}?{{ nav_querystring }}{% endif %}"
            class="btn btn-outline-secondary btn-sm"
            title="Next DR">
            next
          </a>
        {% endif %}
      </div>
    </div>
    
  </div>

  <form method="post" enctype="multipart/form-data" novalidate>
    {% csrf_token %}

    {% if form.errors or form.non_field_errors or formset.total_error_count or formset.non_form_errors %}
      <div class="alert alert-danger mb-3">

        <strong>There were problems saving this Delivery Receipt:</strong>

        <ul class="mt-2 small">

          <!-- FORM FIELD ERRORS -->
          {% for field, errors in form.errors.items %}
            {% for error in errors %}
              <li><strong>{{ field|capfirst }}:</strong> {{ error }}</li>
            {% endfor %}
          {% endfor %}

          <!-- FORM NON-FIELD ERRORS -->
          {% for error in form.non_field_errors %}
            <li>{{ error }}</li>
          {% endfor %}

          <!-- FORMSET ROW ERRORS -->
          {% for f in formset.forms %}
            {% if f.errors %}
              <li>
                <strong>Item Row {{ forloop.counter }}:</strong>
                <ul>
                  {% for field, errors in f.errors.items %}
                    {% for error in errors %}
                      <li>{{ field|capfirst }}: {{ error }}</li>
                    {% endfor %}
                  {% endfor %}
                </ul>
              </li>
            {% endif %}
          {% endfor %}

          <!-- FORMSET NON-FIELD ERRORS -->
          {% for error in formset.non_form_errors %}
            <li>{{ error }}</li>
          {% endfor %}
        </ul>
      </div>
    {% endif %}
    

<div class="row g-4">
{% if not is_create %}
  <!-- LEFT SIDEBAR: DR LIFECYCLE -->
  <div class="col-lg-3">
    <div class="card shadow-sm sticky-top" style="top: 1rem;">
      <div class="card-header py-2">
        <strong>Current Status</strong>
      </div>

      <ul class="list-group list-group-flush small po-lifecycle">
        {% for step in dr_flow %}
          <li class="list-group-item d-flex align-items-center
            {% if step.is_current %} po-step-active {% endif %}
            {% if step.is_done %} po-step-complete {% endif %}
            {% if approval_status == 'DECLINED' and step.is_current %} po-step-declined {% endif %}
          ">
            <span class="me-2 po-step-icon">
              {% if step.is_done %}‚úì{% elif step.is_current %}‚óè{% else %}‚óã{% endif %}
            </span>
            <span class="po-step-label">{{ step.label }}</span>
          </li>
        {% endfor %}
      </ul>
    </div>
  </div>

  <!-- RIGHT MAIN CONTENT -->
  <div class="col-lg-9">
    <!-- NEXT STEP CARD -->
    {% if stage != "NEW_DR" and not dr.is_archived or dr.is_cancelled %}
    <div class="card mb-3
      {% if dr.is_cancelled %}border-danger
      {% elif approval_status == 'DECLINED' %}border-danger
      {% elif approval_status == 'PENDING' %}border-warning
      {% else %}border-secondary{% endif %}
    ">

      <div class="card-body">

        <h6 class="mb-1">Next Step</h6>

        {# ===== STATUS MESSAGE ===== #}
        {% if dr.is_cancelled %}
          <p class="small text-danger fw-semibold mb-2">
            ‚ö† This Delivery Receipt has been cancelled.
          </p>
          <p class="small text-muted mb-0">
            Cancelled DRs cannot proceed further in the workflow.
          </p>
        {% elif stage == "DEPOSITED" %}
          <p class="small text-muted mb-2">
            This Delivery Receipt has completed its lifecycle.
          </p>

        {% elif dr.approval_status == "DECLINED" %}
        <div class="alert alert-danger mt-2 mb-2">
          <strong>Rejected:</strong><br>
          {{ dr.reject_problem|linebreaksbr }}
        </div>

        {% elif missing_fields %}
          <p class="small text-muted mb-2">
            Reminder: Fill up
            <strong>{{ missing_fields|join:", "|humanize_step }}</strong>
            before moving to
            <strong>{{ next_step|humanize_step }}</strong>.
          </p>

        {% else %}
          <p class="small text-muted mb-2">
            Move this Delivery Receipt to
            <strong>{{ next_step|humanize_step }}</strong>.
          </p>
        {% endif %}

        {# ===== ACTION BUTTONS ===== #}

        <div class="d-flex gap-2">
          {% if dr.is_cancelled %}
            <span class="badge bg-warning text-dark">
              Cancelled
            </span>

          {% else %}
            {% if can_approve %}
              <button name="action" value="approve" class="btn btn-sm btn-success">
                Approve
              </button>
              <button
                type="button"
                class="btn btn-outline-danger btn-sm"
                data-dr-id="{{ dr.id }}"
                data-action-url="{% url 'dr-decline' dr.id %}"
                data-bs-toggle="modal"
                data-bs-target="#declineModal">
                Decline
              </button>
            {% endif %}

              {% if stage == "DEPOSITED" or stage == "DELIVERED" and dr.delivery_method == "SAMPLE" %}
              <button
                type="button"
                class="btn btn-sm btn-success"
                data-bs-toggle="modal"
                data-bs-target="#archiveModal"
              >
                Archive
              </button>


            {% elif not missing_fields and approval_status == 'APPROVED' and next_step %}
              <a href="{{ kanban_url }}" class="btn btn-sm btn-outline-primary">
                Go to Dashboard
              </a>
            {% endif %}
          {% endif %}
        </div>

      </div>
    </div>
        {% endif %}
        {% endif %}





    <div class="row g-4">
      <!-- LEFT: Branding + Client info -->
      <div class="col-lg-7">
        <div class="card shadow-sm mb-3">
          <div class="card-body">
              {% if dr.payment_status == "DEPOSITED" %}
                <span class="badge bg-success">Completed</span>
              {% endif %}

            <!-- Client selection + quick add -->
            <div class="mb-3">
              <label class="form-label">{{ form.client.label }} <span class="text-danger">*</span></label>
              <div class="d-flex gap-2 align-items-start">
                <div class="position-relative flex-grow-1">
                  <!-- Visible search input -->
                  <input
                    type="text"
                    id="client-search"
                    class="form-control"
                    placeholder="Search client‚Ä¶"
                    autocomplete="off"
                    value="{% if form.instance.client %}{{ form.instance.client.company_name }}{% endif %}"
                  >

                  <!-- Actual Django-bound client ID -->
                  <input
                    type="hidden"
                    name="client"
                    id="client-id"
                    value="{% if form.instance.client %}{{ form.instance.client.id }}{% endif %}"
                  >

                  <!-- Suggestions -->
                  <div
                    id="client-suggestions"
                    class="list-group position-absolute w-100 shadow-sm"
                    style="z-index:1050; display:none; max-height:240px; overflow-y:auto;"
                  ></div>

                  <!-- Preload client data -->
                  <script type="application/json" id="client-data">
                    [
                      {% for c in clients %}
                        {
                          "id": {{ c.id }},
                          "name": "{{ c.company_name|escapejs }}"
                        }{% if not forloop.last %},{% endif %}
                      {% endfor %}
                    ]
                  </script>
                </div>

                <a href="{% url 'client-create' %}" target="_blank" class="btn btn-outline-secondary btn-sm">
                  + New Client
                </a>
              </div>
              {% if form.client.errors %}
                <div class="text-danger small">{{ form.client.errors }}</div>
              {% endif %}
            </div>

            <!-- Bill / Shipping Address & Invoice Address -->
            <div class="row">
              <div class="col-md-6">
                <div class="border rounded p-3 mb-3 bg-light">
                  <div class="fw-semibold text-warning mb-2">Bill / Shipping Address</div>
                  <div class="small text-muted mb-1">Name:</div>
                  <div id="client-name" class="fw-semibold mb-2">‚Äî</div>

                  <div class="small text-muted mb-1">Contact No.:</div>
                  <div id="client-contact" class="mb-2">‚Äî</div>

                  <div class="small text-muted mb-1">Contact Person:</div>
                  <div id="client-contact-person" class="mb-2">‚Äî</div>

                  <div class="small text-muted mb-1">Delivery Address:</div>
                  <div id="client-address" class="mb-2">‚Äî</div>
                </div>
              </div>
              <div class="col-md-6">
                <div class="border rounded p-3 mb-3 bg-light">
                  <div class="fw-semibold text-warning mb-2">Invoice Address</div>

                  <div class="small text-muted mb-1">Name:</div>
                  <div class="fw-semibold mb-2">Bond Solutions Incorporated</div>

                  <div class="small text-muted mb-1">Contact No.:</div>
                  <div class="mb-2">0962-577-9791</div>

                  <div class="small text-muted mb-1">Delivery Address:</div>
                  <div class="mb-2">FSS Building 1 Scout Castor, corner Scout Tuazon, Barangay Laging Handa, Quezon City</div>
                </div>
              </div>

            </div>

          </div>
        </div>

        <!-- ITEMS TABLE -->
        <div class="card shadow-sm">
          <div class="card-body">
            <div class="d-flex justify-content-between align-items-center mb-3">
              <h5 class="mb-0">Items</h5>
              <small class="text-muted">Item, Description, Qty, Unit Price, Total</small>
            </div>

            {{ formset.management_form }}
              {{ f.id }}  <!-- hidden field; REQUIRED -->
            <div class="table-responsive">
              <table class="table table-sm table-borderless align-middle w-100">
                <thead class="table-light">
                  <tr>
                    <th style="width: 22%">Item</th>
                    <th style="width: 32%">Description</th>
                    <th style="width: 12%">Qty</th>
                    <th style="width: 17%">Unit Price</th>
                    <th style="width: 17%">Total</th>
                  </tr>
                </thead>

                <tbody id="dr-items-body">
                  {% for f in formset.forms %}
                    {{ f.id }}  <!-- hidden field; REQUIRED -->
                    <tr class="dr-item-row">
                      <td>
                        {{ f.product }}
                        {% if f.product.errors %}
                          <div class="text-danger small">{{ f.product.errors|join:", " }}</div>
                        {% endif %}
                      </td>
                      <td>
                        {{ f.description }}
                        {% if f.description.errors %}
                          <div class="text-danger small">{{ f.description.errors|join:", " }}</div>
                        {% endif %}
                      </td>
                      <td>
                        {{ f.quantity }}
                        {% if f.quantity.errors %}
                          <div class="text-danger small">{{ f.quantity.errors|join:", " }}</div>
                        {% endif %}
                      </td>
                      <td>
                        {{ f.unit_price }}
                        {% if f.unit_price.errors %}
                          <div class="text-danger small">{{ f.unit_price.errors|join:", " }}</div>
                        {% endif %}
                      </td>
                      <td class="line-total-cell">
                        {% if f.instance.pk %}
                          {{ f.instance.line_total }}
                        {% else %}
                          ‚Äî
                        {% endif %}
                      </td>
                    </tr>

                    {% if f.non_field_errors %}
                      <tr>
                        <td colspan="6">
                          <div class="text-danger small">
                            {% for err in f.non_field_errors %}
                              ‚Ä¢ {{ err }}<br>
                            {% endfor %}
                          </div>
                        </td>
                      </tr>
                    {% endif %}
                  {% endfor %}
                </tbody>
              </table>
            </div>

            <div class="d-flex justify-content-end">
              <div class="text-end">
                <div class="fw-semibold">Subtotal:</div>
                <div id="subtotal-display" class="fs-5 fw-bold">‚Ç±0.00</div>
              </div>
            </div>

          </div>
        </div>
      </div>

      <!-- RIGHT: Order details / comments -->
      <div class="col-lg-5">
        <div class="card shadow-sm mb-3">
          <div class="card-body">

            <div class="row g-2 mb-3">
              <div class="col-6">
                <label class="form-label">{{ form.date_of_order.label }}</label>
                {{ form.date_of_order|add_class:"form-control" }}
              </div>
              <div class="col-6">
                <label class="form-label">{{ form.dr_number.label }}</label>
                {{ form.dr_number|add_class:"form-control" }}
              </div>
            </div>

            <div class="row g-2 mb-3">
              <div class="col-6">
                <label class="form-label">{{ form.payment_method.label }}</label>
                {{ form.payment_method|add_class:"form-select" }}
              </div>
              <div class="col-6">
                <label class="form-label">{{ form.delivery_method.label }}</label>
                {{ form.delivery_method|add_class:"form-select" }}
              </div>
            </div>
            <!-- SOURCE DR (Door to Door only) -->
            {% if form.source_dr %}
            <div class="row g-2 mb-3" id="source-dr-row" style="display:none;">
              <div class="col-12">
                <label class="form-label">
                  {{ form.source_dr.label }}
                  <span class="text-danger">*</span>
                </label>
                {{ form.source_dr|add_class:"form-select" }}
                {% if form.source_dr.errors %}
                  <div class="text-danger small">{{ form.source_dr.errors }}</div>
                {% endif %}
              </div>
            </div>
            {% endif %}

            <div class="row g-2 mb-3">
              <div class="col-6">
                <label class="form-label">{{ form.agent.label }}</label>
                {{ form.agent|add_class:"form-select" }}
              </div>

              <div class="col-6">
                <label class="form-label">Delivery Date</label>

                {% if stage == "FOR_DELIVERY" %}
                    {{ form.date_of_delivery|add_class:"form-control" }}

                    <!-- Date limits -->
                    <script>
                      const dInput = document.querySelector('input[name="date_of_delivery"]');
                      if (dInput) {
                        const today = new Date();
                        const max = new Date();
                        max.setDate(today.getDate() + 3);
                        dInput.min = today.toISOString().split("T")[0];
                        dInput.max = max.toISOString().split("T")[0];
                      }
                    </script>

                    <!-- Small red text showing due date -->
                    <small class="text-danger d-block mt-1">
                      {% if dr.payment_due %}
                          Due date is: {{ dr.payment_due|date:"F j, Y" }}
                      {% else %}
                          {% now "U" as now_ts %}
                          {% with now_ts|add:"259200"|date:"F j, Y" as future_due %}
                              Due date will be: {{ future_due }}
                          {% endwith %}
                      {% endif %}
                    </small>

                {% else %}
                    {{ form.date_of_delivery|add_class:"form-control" }}
                {% endif %}
              </div>

            </div>

            <div class="row g-2 mb-3">
              <div class="col-6">
                <label class="form-label">Payment Due</label>
                {{ form.payment_due|add_class:"form-control" }}
              </div>
            </div>
            <div class="mb-3">
              <label class="form-label">Payment Details</label>
              {{ form.payment_details|add_class:"form-control" }}
            </div>
            <div class="row g-2 mt-3">
              <div class="col-6">
                {{ form.sales_invoice_no.label_tag }}
                {{ form.sales_invoice_no }}
              </div>

              <div class="col-6">
                {{ form.deposit_slip_no.label_tag }}
                {{ form.deposit_slip_no }}
              </div>
            </div>
            <div class="row g-2 mb-3 mt-3">
              <div class="col-6">
                <label class="form-label">Delivery Status</label>
                {{ form.delivery_status }}
              </div>

              <div class="col-6">
                <label class="form-label">Payment Status</label>
                {{ form.payment_status }}
              </div>
            </div>
            {% if not is_create and is_top_management  %}
            <form method="post"
                  action="{% url 'dr-cancel' dr.id %}"
                  class="d-inline"
                  onsubmit="return confirm('Cancel this Delivery Receipt? This cannot be undone.')">
              {% csrf_token %}
              <button type="submit" class="btn btn-outline-danger" style="margin-right: 10px;">
                Cancel DR
              </button>
            </form>
              <!-- Delete DR trigger -->
            <button
              type="button"
              class="btn btn-danger"
              data-bs-toggle="modal"
              data-bs-target="#deleteDrModal">
              Delete DR
            </button>
          {% endif %}

            <div class="mb-3 mt-3">
              {{ form.proof_of_delivery.label_tag }}

              {% if stage == "DELIVERED" %}
                {{ form.proof_of_delivery }}
                <small class="text-muted d-block">
                  Upload or replace proof of delivery.
                </small>
              {% endif %}

              {% if form.instance.pk and form.instance.proof_of_delivery and form.instance.proof_of_delivery.name %}
                <div class="mt-2">
                  <img
                    src="{{ form.instance.proof_of_delivery.url }}"
                    class="img-thumbnail"
                    style="max-height: 200px; cursor:pointer"
                    data-bs-toggle="modal"
                    data-bs-target="#podModal"
                  >
                </div>
              {% endif %}
            </div>


            <div class="mb-3">
              <label class="form-label">Comments / Special Instructions</label>
              {{ form.remarks|add_class:"form-control" }}
            </div>

          </div>
        </div>

        <div class="d-flex justify-content-end">
          {% if not is_create %}
            <a href="{% url 'dr-print' dr.id %}" target="_blank" class="btn btn-outline-secondary btn-sm" style="margin-right: 10px;">
              üñ® Print DR
            </a>
          {% endif %}
          <button
            type="button"
            class="btn btn-outline-secondary"
            id="discard-btn"
            style="margin-right: 10px;"
            >
            Discard
          </button>
          {% if dr.approval_status == "DECLINED" %}
          <button
            type="button"
            class="btn btn-success"
            data-bs-toggle="modal"
            data-bs-target="#resolveModal">
            Resolve
          </button>
          {% else %}
          <button type="submit" name="action" value="save" class="btn btn-primary px-4">
            Save
          </button>
          {% endif %}
        </div>

      </div>
    </div>
            {% if not is_create and updates %}
          <div class="card shadow-sm mt-4">
            <div class="card-body">

              <h5 class="mb-3">Update History</h5>

              <ul class="list-group small">
                {% for u in updates %}
                <li class="list-group-item d-flex justify-content-between align-items-center">
                  <div>
                    <strong>{{ u.timestamp|date:"Y-m-d H:i" }}</strong><br>
                    <span class="text-muted">by {{ u.user.get_full_name|default:u.user.username }}</span>
                  </div>
                  <button
                    type="button"
                    class="btn btn-outline-secondary btn-sm"
                    data-bs-toggle="modal"
                    data-bs-target="#updateModal-{{ u.id }}"
                  >
                    View
                  </button>
                </li>

                <!-- Modal -->
                <div class="modal fade" id="updateModal-{{ u.id }}" tabindex="-1">
                  <div class="modal-dialog modal-dialog-centered">
                    <div class="modal-content">
                      <div class="modal-header">
                        <h6 class="modal-title">Update Details</h6>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                      </div>
                      <div class="modal-body">
                        <div class="mb-2">
                          <strong>Date:</strong> {{ u.timestamp|date:"Y-m-d H:i" }}<br>
                          <strong>User:</strong> {{ u.user.get_full_name|default:u.user.username }}
                        </div>
                        <div class="mb-2">
                          <strong>System Message:</strong><br>
                          <div class="text-muted">{{ u.system_update }}</div>
                        </div>
                        {% if u.user_notes %}
                        <div class="mb-2">
                          <strong>User Notes:</strong><br>
                          <div>{{ u.user_notes }}</div>
                        </div>
                        {% endif %}
                      </div>
                      <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                          Close
                        </button>
                      </div>
                    </div>
                  </div>
                </div>

                {% endfor %}
              </ul>
            </div>
          </div>
          {% endif %}
      </div> <!-- /col-lg-9 -->
</div>   <!-- /row -->


  </form>
</div>
<!-- DECLINE DR MODAL -->
<div class="modal fade" id="declineModal" tabindex="-1">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content shadow">

      <form id="declineForm" method="post">
        {% csrf_token %}

        <div class="modal-header bg-danger text-white">
          <h5 class="modal-title">Reject Delivery Receipt</h5>
          <button type="button" class="btn-close btn-close-white"
                  data-bs-dismiss="modal"></button>
        </div>

        <div class="modal-body">
          <div class="mb-3">
            <label class="form-label fw-semibold">
              Reason for Rejection
            </label>
            <textarea
              name="reject_problem"
              class="form-control"
              rows="3"
              placeholder="What is wrong with this DR?"
              required></textarea>
          </div>

          <div class="mb-3">
            <label class="form-label fw-semibold">
              Suggested Fix (optional)
            </label>
            <textarea
              name="reject_solution"
              class="form-control"
              rows="3"
              placeholder="What needs to be corrected?"></textarea>
          </div>
        </div>

        <div class="modal-footer">
          <button type="button"
                  class="btn btn-outline-secondary"
                  data-bs-dismiss="modal">
            Cancel
          </button>
          <button type="submit" class="btn btn-danger">
            Reject DR
          </button>
        </div>

      </form>

    </div>
  </div>
</div>

{% if is_top_management %}
<div class="modal fade" id="deleteDrModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">

      <div class="modal-header">
        <h5 class="modal-title text-danger">Delete Delivery Receipt</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>

      <form method="post" action="{% url 'dr-delete' dr.id %}">
        {% csrf_token %}

        <div class="modal-body">
          <p class="text-danger fw-semibold">
            This will permanently delete this Delivery Receipt.
          </p>

          <p class="small text-muted">
            This action <strong>cannot be undone</strong>.
          </p>

          <hr>

          <p class="small">
            To confirm, type the DR Number exactly:
          </p>

          <div class="mb-2">
            <input
              type="text"
              name="confirm_text"
              class="form-control"
              placeholder="Type {{ dr.dr_number }}"
              required
              autocomplete="off">
          </div>
        </div>

        <div class="modal-footer">
          <button
            type="button"
            class="btn btn-secondary"
            data-bs-dismiss="modal">
            Cancel
          </button>

          <button
            type="submit"
            class="btn btn-danger">
            Permanently Delete
          </button>
        </div>

      </form>
    </div>
  </div>
</div>
{% endif %}

<!-- PROOF OF DELIVERY MODAL -->
 <div class="modal fade" id="podModal" tabindex="-1">
  <div class="modal-dialog modal-dialog-centered modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Proof of Delivery</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body text-center">
        {% if form.instance.pk and form.instance.proof_of_delivery and form.instance.proof_of_delivery.name %}
        <img src="{{ form.instance.proof_of_delivery.url }}" class="img-fluid rounded">
        {% endif %}
      </div>
    </div>
  </div>
</div>

<!-- ARCHIVE CONFIRMATION MODAL -->
<div class="modal fade" id="archiveModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">

      <div class="modal-header">
        <h5 class="modal-title">Archive Delivery Receipt</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>

      <div class="modal-body">
        This will archive this Delivery Receipt and remove it from active workflows.
        <br><br>
        This action cannot be undone.
      </div>

      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
          Cancel
        </button>

        <form method="post" action="" class="m-0 p-0">
          {% csrf_token %}
          <input type="hidden" name="action" value="archive">
          <button type="submit" class="btn btn-success">
            Archive
          </button>
        </form>
      </div>

    </div>
  </div>
</div>

<!-- RESOLVE MODAL -->
<div class="modal fade" id="resolveModal" tabindex="-1">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content shadow">

      <form method="post">
        {% csrf_token %}
        <input type="hidden" name="action" value="resolve">

        <div class="modal-header bg-success text-white">
          <h5 class="modal-title">Resolve Rejection</h5>
          <button type="button" class="btn-close btn-close-white"
                  data-bs-dismiss="modal"></button>
        </div>

        <div class="modal-body">

          <div class="mb-3">
            <label class="form-label fw-semibold">
              Rejection Reason
            </label>
            <textarea class="form-control" rows="3" readonly>
{{ dr.reject_problem }}
            </textarea>
          </div>

          <div class="mb-3">
            <label class="form-label fw-semibold">
              Resolution / Fix Applied
            </label>
            <textarea
              name="resolved_note"
              class="form-control"
              rows="4"
              placeholder="What was corrected?"
              required></textarea>
          </div>

        </div>

        <div class="modal-footer">
          <button type="button"
                  class="btn btn-outline-secondary"
                  data-bs-dismiss="modal">
            Cancel
          </button>
          <button class="btn btn-success">
            Mark as Resolved
          </button>
        </div>

      </form>

    </div>
  </div>
</div>


{% endblock %}

{% block extra_js %}

<script>
document.addEventListener("DOMContentLoaded", function () {
  const form = document.querySelector("form");
  const discardBtn = document.getElementById("discard-btn");

  if (!form) return;

  let isDirty = false;
  let isSubmitting = false;

  // Capture initial state
  const initialData = new FormData(form);

  function hasFormChanged() {
    const currentData = new FormData(form);
    for (let [key, value] of currentData.entries()) {
      if (initialData.get(key) !== value) {
        return true;
      }
    }
    return false;
  }

  // Track real user changes only
  form.addEventListener("input", () => {
    isDirty = hasFormChanged();
  });

  form.addEventListener("change", () => {
    isDirty = hasFormChanged();
  });

  // SAVE ‚Üí disable warning
  form.addEventListener("submit", () => {
    isSubmitting = true;
    isDirty = false;
  });

  // Discard button
  if (discardBtn) {
    discardBtn.addEventListener("click", function () {
      if (!hasFormChanged()) {
        window.history.back();
        return;
      }

      const ok = confirm(
        "You have unsaved changes.\n\nIf you leave now, your changes will be lost.\n\nContinue?"
      );

      if (ok) {
        window.history.back();
      }
    });
  }

  // Browser unload protection
  window.addEventListener("beforeunload", function (e) {
    if (!isDirty || isSubmitting) return;
    e.preventDefault();
    e.returnValue = "";
  });
});
</script>



<script>
function formatPeso(value) {
  return "‚Ç±" + value.toLocaleString("en-PH", {
    minimumFractionDigits: 2,
    maximumFractionDigits: 2,
  });
}

document.addEventListener("DOMContentLoaded", function () {
  const deliveryMethodSelect = document.querySelector('select[name="delivery_method"]');
  const sourceDrRow = document.getElementById("source-dr-row");
  const sourceDrSelect = document.querySelector('select[name="source_dr"]');

  function toggleSourceDr() {
    if (!deliveryMethodSelect || !sourceDrRow) return;

    const isD2D = deliveryMethodSelect.value === "DOOR_TO_DOOR";
    sourceDrRow.style.display = isD2D ? "" : "none";

    if (!isD2D && sourceDrSelect) sourceDrSelect.value = "";
  }

  if (deliveryMethodSelect) {
    deliveryMethodSelect.addEventListener("change", toggleSourceDr);
    toggleSourceDr();
  }

  // IMPORTANT: bind source_dr change here (after DOM exists)
  if (sourceDrSelect) {
    sourceDrSelect.addEventListener("change", function () {
      const drId = this.value;
      if (!drId) return;

      console.log("Source DR selected:", drId);

      fetch(`/dr/${drId}/d2d-transactions/`)
        .then(res => res.json())
        .then(data => {
          if (!data.ok) {
            console.warn("D2D API returned ok:false");
            return;
          }

          const rows = document.querySelectorAll(".dr-item-row");
          data.items.forEach((item, idx) => {
            const row = rows[idx];
            if (!row) return;

            const product = row.querySelector('select[name$="-product"]');
            const qty = row.querySelector('input[name$="-quantity"]');
            const price = row.querySelector('input[name$="-unit_price"]');
            const desc = row.querySelector('input[name$="-description"]');

            if (!product || !qty || !price) return;

            product.value = String(item.product_id);
            qty.value = String(item.remaining_qty);
            price.value = String(item.unit_price);
            if (desc) desc.value = item.description || "";

            // üîÅ trigger recompute
            qty.dispatchEvent(new Event("input", { bubbles: true }));
            price.dispatchEvent(new Event("input", { bubbles: true }));
          });

          console.log("Autofill done.");
        })
        .catch(err => console.error("D2D autofill failed:", err));
    });
  }
});
</script>
<script>
document.addEventListener("DOMContentLoaded", function () {
  const input = document.getElementById("client-search");
  const hidden = document.getElementById("client-id");
  const list = document.getElementById("client-suggestions");
  const raw = document.getElementById("client-data");

  if (!input || !hidden || !list || !raw) return;

  const clients = JSON.parse(raw.textContent);

  function clearSuggestions() {
    list.innerHTML = "";
    list.style.display = "none";
  }

  input.addEventListener("input", function () {
    const q = this.value.trim().toLowerCase();
    clearSuggestions();

    if (!q) {
      hidden.value = "";
      return;
    }

    const matches = clients.filter(c =>
      c.name.toLowerCase().includes(q)
    ).slice(0, 10);

    if (!matches.length) return;

    matches.forEach(c => {
      const item = document.createElement("button");
      item.type = "button";
      item.className = "list-group-item list-group-item-action";
      item.textContent = c.name;

      item.addEventListener("click", () => {
        input.value = c.name;
        hidden.value = c.id;
        clearSuggestions();

        // üîÅ Trigger client details load
        document.dispatchEvent(new Event("client:selected"));
      });

      list.appendChild(item);
    });

    list.style.display = "block";
  });

  // Hide when clicking outside
  document.addEventListener("click", function (e) {
    if (!list.contains(e.target) && e.target !== input) {
      clearSuggestions();
    }
  });
});
</script>


<script>
document.addEventListener("DOMContentLoaded", function () {
  const productDetailUrlTemplate = "{% url 'product-detail-api' 9999 %}";
  function getProductUrl(id) { return productDetailUrlTemplate.replace("9999", id); }

  function updateSubtotal() {
    let total = 0;
    document.querySelectorAll(".line-total-cell").forEach(cell => {
      const text = cell.textContent.replace(/[‚Ç±,]/g, "");
      const val = parseFloat(text);
      if (!isNaN(val)) total += val;
    });
    const subt = document.getElementById("subtotal-display");
    if (subt) subt.textContent = formatPeso(total);
  }

  function setupItemRow(row) {
    const productSelect = row.querySelector('select[name$="-product"]');
    const descInput = row.querySelector('input[name$="-description"]');
    const qtyInput = row.querySelector('input[name$="-quantity"]');
    const priceInput = row.querySelector('input[name$="-unit_price"]');
    const totalCell = row.querySelector(".line-total-cell");

    function updateTotal() {
      const q = parseFloat(qtyInput?.value || "0");
      const p = parseFloat(priceInput?.value || "0");
      const t = q * p;
      if (totalCell) totalCell.textContent = t > 0 ? formatPeso(t) : "‚Äî";
      updateSubtotal();
    }

    if (productSelect) {
      productSelect.addEventListener("change", function () {
        const id = this.value;
        if (!id) return;
        fetch(getProductUrl(id))
          .then(r => r.json())
          .then(data => {
            if (descInput) descInput.value = data.name || "";
            if (priceInput && !priceInput.value && data.default_unit_price !== null) {
              priceInput.value = data.default_unit_price;
            }
            updateTotal();
          })
          .catch(() => {});
      });
    }

    if (qtyInput) qtyInput.addEventListener("input", updateTotal);
    if (priceInput) priceInput.addEventListener("input", updateTotal);
    updateTotal();
  }

  document.querySelectorAll(".dr-item-row").forEach(setupItemRow);
  updateSubtotal();
});
</script>
<script>
document.getElementById("declineModal")
  ?.addEventListener("show.bs.modal", function (event) {

    const button = event.relatedTarget;
    const actionUrl = button.getAttribute("data-action-url");

    const form = document.getElementById("declineForm");
    form.action = actionUrl;

    // Clear old values
    form.querySelector('[name="reject_problem"]').value = "";
    form.querySelector('[name="reject_solution"]').value = "";
});
</script>

<script>
document.addEventListener("DOMContentLoaded", function () {
  const hiddenClientId = document.getElementById("client-id");
  const clientDetailUrlTemplate = "{% url 'client-detail-api' 9999 %}";

  function getClientUrl(id) {
    return clientDetailUrlTemplate.replace("9999", id);
  }

  function fillClientDisplay(data) {
    const nameEl = document.getElementById("client-name");
    const contactEl = document.getElementById("client-contact");
    const personEl = document.getElementById("client-contact-person");
    const addressEl = document.getElementById("client-address");

    if (nameEl) nameEl.textContent = data.company_name || "‚Äî";
    if (contactEl) contactEl.textContent = data.contact_number || "‚Äî";
    if (personEl) personEl.textContent = data.name_of_owner || "‚Äî";
    if (addressEl) addressEl.textContent = data.full_address || "‚Äî";
  }

  function clearClientDisplay() {
    ["client-name", "client-contact", "client-contact-person", "client-address"]
      .forEach(id => {
        const el = document.getElementById(id);
        if (el) el.textContent = "‚Äî";
      });
  }

  function loadClientDetails() {
    if (!hiddenClientId || !hiddenClientId.value) {
      clearClientDisplay();
      return;
    }

    fetch(getClientUrl(hiddenClientId.value))
      .then(res => {
        if (!res.ok) throw new Error("Client fetch failed: " + res.status);
        return res.json();
      })
      .then(fillClientDisplay)
      .catch(err => {
        console.error("Client autofill failed:", err);
        clearClientDisplay();
      });
  }

  // ‚úÖ Run on page load (edit / reopen DR)
  loadClientDetails();

  // ‚úÖ ALSO run when a client is selected from autocomplete
  document.addEventListener("client:selected", loadClientDetails);
});
</script>

<script>
document.addEventListener("DOMContentLoaded", function () {
  const declineForm = document.getElementById("declineForm");
  if (!declineForm) return;

  declineForm.addEventListener("submit", function (e) {
    e.preventDefault();

    const actionUrl = declineForm.action;
    if (!actionUrl) return;

    const formData = new FormData(declineForm);

    fetch(actionUrl, {
      method: "POST",
      headers: {
        "X-CSRFToken": document.querySelector('[name=csrfmiddlewaretoken]').value
      },
      body: formData
    })
    .then(res => res.json())
    .then(data => {
      if (!data.ok) {
        throw new Error(data.error || "Reject failed.");
      }

      // ‚úÖ EXACT behavior match with Kanban:
      // After reject ‚Üí go back to Kanban
      window.location.reload();
    })
    .catch(err => {
      alert(err.message);
    });
  });
});
</script>


{% endblock %}
