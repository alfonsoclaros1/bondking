{% extends "base.html" %}
{% load static %}
{% load humanize %}
{% load user_groups %}

{% block title %}Purchase Orders Table{% endblock %}

{% block content %}
<div class="container-fluid py-3">

  <!-- Header -->
  <div class="d-flex justify-content-between align-items-center mb-3">
    <h4 class="mb-0">Purchase Orders</h4>
    <div class="d-flex gap-2">
      <a href="{% url 'po-create' %}" class="btn btn-primary btn-sm">New PO</a>
    </div>
  </div>

  <!-- Filters -->
  <div class="card shadow-sm mb-3">
    <div class="card-body">
      <form method="get" id="po-filter-form">

        <!-- SMART SEARCH -->
        <div class="mb-2">
          <label class="form-label small text-muted">Search</label>
          <div class="bk-search-wrap position-relative">
            <input
              type="text"
              class="form-control form-control-sm"
              id="bk-global-search"
              placeholder="Type to search (e.g., RVT, PO-2026, ABC Trading, Approved, CHECK_SIGNING)..."
              autocomplete="off"
            >

            <div id="bk-tags" class="bk-tags mt-2"></div>

            <div
              id="bk-suggestions"
              class="list-group position-absolute w-100 shadow-sm"
              style="z-index:1050; display:none; max-height:280px; overflow-y:auto;"
            ></div>

            <div id="bk-hidden-inputs"></div>

            <input type="hidden" name="q" id="bk-q" value="{{ selected.q|default:'' }}">
            <input type="hidden" name="sort_by" id="bk-sort-by" value="{{ sort_by }}">
          </div>
        </div>

        <!-- MORE FILTERS -->
        <button
          type="button"
          class="btn btn-link p-0 small d-inline-flex align-items-center gap-1"
          id="bk-more-filters-btn"
        >
          <span id="bk-more-filters-text">More Filters</span>
          <i class="bi bi-chevron-down transition-icon" id="bk-more-filters-icon"></i>
        </button>

        <div id="bk-more-filters-panel" class="mt-2" style="display:none;">
          <div class="row g-2 align-items-end">

            <div class="col-md-3">
              <label class="form-label small text-muted">Paid To</label>
              <input type="text" class="form-control form-control-sm" name="paid_to"
                     placeholder="Supplier name…" value="">
            </div>

            <div class="col-md-3">
              <label class="form-label small text-muted">Prepared By</label>
              <select name="prepared_by" class="form-select form-select-sm">
                <option value="">All</option>
                {% for u in users %}
                  <option value="{{ u.id }}">
                    {{ u.get_full_name|default:u.username }}
                  </option>
                {% endfor %}
              </select>
            </div>

            <div class="col-md-3">
              <label class="form-label small text-muted">Status</label>
              <select name="status" class="form-select form-select-sm">
                <option value="">All</option>
                {% for s in statuses %}
                  <option value="{{ s }}">{{ s|title }}</option>
                {% endfor %}
              </select>
            </div>

            <div class="col-md-3">
              <label class="form-label small text-muted">Approval Status</label>
              <select name="approval_status" class="form-select form-select-sm">
                <option value="">All</option>
                {% for val,label in approval_statuses %}
                  <option value="{{ val }}">{{ label }}</option>
                {% endfor %}
              </select>
            </div>

            <div class="col-md-3">
              <label class="form-label small text-muted">Start Date</label>
              <input type="date" name="start_date" class="form-control form-control-sm"
                     value="{{ selected.start_date|default:'' }}">
            </div>

            <div class="col-md-3">
              <label class="form-label small text-muted">End Date</label>
              <input type="date" name="end_date" class="form-control form-control-sm"
                     value="{{ selected.end_date|default:'' }}">
            </div>

            <div class="col-md-3">
              <label class="form-label small text-muted">Product ID</label>
              <select name="product_id" class="form-select form-select-sm">
                <option value="">All</option>
                {% for p in product_ids %}
                  <option value="{{ p.id }}">{{ p.code }}</option>
                {% endfor %}
              </select>
            </div>

          </div>
        </div>

        <!-- ACTION ROW -->
        <div class="d-flex flex-wrap align-items-center gap-3 mt-3">
          <button class="btn btn-sm btn-primary">Apply Filters</button>
          <a href="{% url 'po-table' %}" class="btn btn-sm btn-outline-secondary">Reset</a>

          <a href="{% url 'po-table-export' %}?{{ request.GET.urlencode }}"
             class="btn btn-sm btn-outline-success">
            Export to Excel
          </a>
          <div class="dropdown">
            <button
              class="btn btn-sm btn-outline-primary dropdown-toggle"
              type="button"
              data-bs-toggle="dropdown"
              id="poBulkActionsBtn"
              disabled
            >
              Actions
            </button>

            <ul class="dropdown-menu">
              <li>
                <button type="button" class="dropdown-item" onclick="poBulkOpen()">
                  Open
                </button>
              </li>

              {% if is_top_management %}
                <li><hr class="dropdown-divider"></li>
                <li>
                  <button type="button" class="dropdown-item text-warning" onclick="poBulkArchive()">
                    Archive
                  </button>
                </li>
                <li>
                  <button type="button" class="dropdown-item text-danger" onclick="poBulkCancel()">
                    Cancel
                  </button>
                </li>
              {% endif %}
            </ul>
          </div>

          <!-- SORT DROPDOWN BUTTON -->
          <div class="dropdown">
            <button class="btn btn-sm btn-outline-secondary dropdown-toggle" type="button" data-bs-toggle="dropdown">
              Sort
            </button>
            <ul class="dropdown-menu">
              <li><button type="button" class="dropdown-item" data-sort="date_desc">Date (Newest)</button></li>
              <li><button type="button" class="dropdown-item" data-sort="date_asc">Date (Oldest)</button></li>
              <li><button type="button" class="dropdown-item" data-sort="total_desc">Total (High → Low)</button></li>
              <li><button type="button" class="dropdown-item" data-sort="total_asc">Total (Low → High)</button></li>
              <li><button type="button" class="dropdown-item" data-sort="po_desc">PO No. (Desc)</button></li>
              <li><button type="button" class="dropdown-item" data-sort="po_asc">PO No. (Asc)</button></li>
            </ul>
          </div>

          <!-- INLINE CHECKBOXES (AUTO APPLY) -->
          <div class="form-check form-check-inline mb-0">
            <input class="form-check-input" type="checkbox" name="hide_archived" value="1"
                   {% if hide_archived %}checked{% endif %}>
            <label class="form-check-label small text-muted">Hide Archived</label>
          </div>

          <div class="form-check form-check-inline mb-0">
            <input class="form-check-input" type="checkbox" name="hide_cancelled" value="1"
                   {% if hide_cancelled %}checked{% endif %}>
            <label class="form-check-label small text-muted">Hide Cancelled</label>
          </div>
        </div>

      </form>
    </div>
  </div>

  <!-- TABLE -->
  <div class="card shadow-sm">
    <div class="card-body p-0">
      <table class="table table-hover align-middle mb-0 po-table">
        <thead class="table-light">
          <tr>
            <th class="ps-3" style="width:32px;">
              <input type="checkbox" id="select-all">
            </th>
            <th>PO #</th>
            <th>Date</th>
            <th>Paid To</th>
            <th>Product ID</th>
            <th>Status</th>
            <th>Prepared By</th>
            <th>Approval</th>
            <th class="text-end">Total</th>
          </tr>
        </thead>

        <tbody>
          {% for po in page_obj %}
            <tr class="po-row
              {% if po.is_cancelled %}table-danger
              {% elif po.is_archived %}table-success
              {% elif po.status == 'BILLING' and user|has_group:'RVT' %}table-warning
              {% elif po.status == 'BILLING' and user|has_group:'AccountingOfficer' %}table-warning
              {% elif po.status == 'BILLING' and user|has_group:'AccountingHead' %}table-warning              
              {% elif po.status == 'PURCHASE_ORDER_APPROVAL' and user|has_group:'JGG' %}table-warning
              {% elif po.status == 'PURCHASE_ORDER_CREATION' and user|has_group:'RVT' %}table-warning
              {% endif %}
            ">
              <td class="ps-3">
                <input type="checkbox"
                       class="po-checkbox"
                       value="{{ po.id }}"
                       data-total="{{ po.total }}"
                       onclick="event.stopPropagation();">
              </td>

              <td class="fw-semibold">
                <a href="{% url 'po-edit' po.id %}?from=table&{{ request.GET.urlencode }}" class="text-decoration-none">
                  {{ po.po_number }}
                </a>
                {% if po.is_cancelled %}
                  <span class="badge bg-danger ms-2">Cancelled</span>
                {% elif po.is_archived %}
                  <span class="badge bg-success ms-2">Archived</span>
                {% endif %}
              </td>

              <td class="small text-muted">{{ po.date|date:"Y-m-d" }}</td>
              <td>{{ po.paid_to }}</td>
              <td>{{ po.product_id_ref.code }}</td>
              <td><span class="badge bg-secondary">{{ po.status|title }}</span></td>
              <td class="small">{{ po.prepared_by.get_full_name|default:po.prepared_by.username }}</td>

              <td>
                <span class="badge
                  {% if po.approval_status == 'APPROVED' %}bg-success
                  {% elif po.approval_status == 'DECLINED' %}bg-danger
                  {% else %}bg-warning{% endif %}">
                  {{ po.approval_status|title }}
                </span>
              </td>

              <td class="text-end fw-semibold">₱{{ po.total|floatformat:2|intcomma }}</td>
            </tr>
          {% empty %}
            <tr>
              <td colspan="10" class="text-center text-muted py-4">No purchase orders found.</td>
            </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>

    <!-- STICKY FOOTER -->
    <div class="po-table-footer d-flex justify-content-between align-items-center px-3 py-2 border-top">
      <div class="small text-muted" id="po-footer-summary">
        Showing <strong>{{ page_obj.paginator.count }}</strong> PO(s) |
        Total: <strong>₱{{ total_sum|floatformat:2|intcomma }}</strong>
      </div>

      <div class="d-flex align-items-center gap-2">
        <span class="small text-muted">
          Page {{ page_obj.number }} of {{ page_obj.paginator.num_pages }}
        </span>

        <nav aria-label="PO table pagination">
          <ul class="pagination pagination-sm mb-0">
            {% if page_obj.has_previous %}
              <li class="page-item">
                <a class="page-link" href="?{% querystring page=page_obj.previous_page_number %}">‹</a>
              </li>
            {% endif %}
            {% if page_obj.has_next %}
              <li class="page-item">
                <a class="page-link"
                  href="?{{ base_querystring }}{% if base_querystring %}&{% endif %}page={{ page_obj.next_page_number }}">
                  ›
                </a>
              </li>
            {% endif %}
          </ul>
        </nav>
      </div>
    </div>

  </div>
</div>
{% endblock %}

{% block extra_js %}
<style>
/* Sticky footer */
.po-table-footer{
  position: sticky;
  bottom: 0;
  background: #fff;
  z-index: 5;
}

/* Sticky header (page scroll, no inner scrollbar) */
.po-table thead th{
  position: sticky;
  top: 0;
  z-index: 4;
  background: #fff;
  border-bottom: 2px solid #dee2e6;
}

/* Row selection highlight */
.po-row.selected{
  background-color: rgba(13,110,253,0.08);
}

/* Tags */
.bk-tags{display:flex; flex-wrap:wrap; gap:6px;}
.bk-tag{
  display:inline-flex; align-items:center; gap:6px;
  padding:4px 10px; border-radius:999px;
  background: rgba(13,110,253,0.08);
  border: 1px solid rgba(13,110,253,0.18);
  font-size:12px;
}
.bk-tag .bk-tag-key{font-weight:600; color:#0d6efd;}
.bk-tag button{border:none; background:transparent; padding:0; cursor:pointer; color:#6c757d;}
.bk-suggestion-badge{
  font-size:11px; border-radius:999px; padding:2px 8px;
  border:1px solid rgba(0,0,0,.1); background:#f8f9fa; margin-right:8px;
}

/* More/Less */
#bk-more-filters-panel{overflow:hidden; transition:max-height .25s ease, opacity .2s ease;}
.transition-icon{transition:transform .25s ease;}
.transition-icon.rotated{transform:rotate(180deg);}
</style>

<script>
document.addEventListener("DOMContentLoaded", function () {
  const form = document.getElementById("po-filter-form");
  const input = document.getElementById("bk-global-search");
  const box = document.getElementById("bk-suggestions");
  const tagsEl = document.getElementById("bk-tags");
  const hiddenEl = document.getElementById("bk-hidden-inputs");
  const qHidden = document.getElementById("bk-q");
  const sortHidden = document.getElementById("bk-sort-by");

  if (!form || !input || !box || !tagsEl || !hiddenEl || !qHidden || !sortHidden) return;

  // ---------- helpers ----------
  function resetPage() {
    const p = form.querySelector('input[name="page"]');
    if (p) p.remove();
  }

  // ---------- More Filters remembered ----------
  const moreBtn = document.getElementById("bk-more-filters-btn");
  const morePanel = document.getElementById("bk-more-filters-panel");
  const textEl = document.getElementById("bk-more-filters-text");
  const iconEl = document.getElementById("bk-more-filters-icon");
  const LS_KEY = "po_table_more_filters_open";

  function setMoreFilters(open){
    if (!morePanel) return;

    if (open) {
      morePanel.style.display = "block";
      morePanel.style.maxHeight = morePanel.scrollHeight + "px";
      morePanel.style.opacity = "1";
      if (textEl) textEl.textContent = "Less Filters";
      if (iconEl) iconEl.classList.add("rotated");
    } else {
      morePanel.style.maxHeight = "0px";
      morePanel.style.opacity = "0";
      if (textEl) textEl.textContent = "More Filters";
      if (iconEl) iconEl.classList.remove("rotated");
      setTimeout(() => { morePanel.style.display = "none"; }, 250);
    }
    localStorage.setItem(LS_KEY, open ? "1" : "0");
  }

  if (moreBtn && morePanel) {
    setMoreFilters(localStorage.getItem(LS_KEY) === "1");
    moreBtn.addEventListener("click", () => {
      const open = morePanel.style.display !== "none";
      setMoreFilters(!open);
    });
  }

  // ---------- Tag system ----------
  const tags = [];
  const params = new URLSearchParams(window.location.search);

  function addParamTags(param, key){
    const values = params.getAll(param).map(v => (v||"").trim()).filter(v => v !== "");
    const labels = params.getAll(`${param}_label`);
    values.forEach((v,i) => {
      tags.push({
        type: param,
        key,
        value: v,
        display: labels[i] || v,
        labelParam: `${param}_label`,
      });
    });
  }

  addParamTags("paid_to", "Paid To");
  addParamTags("prepared_by", "Prepared By");
  addParamTags("status", "Status");
  addParamTags("approval_status", "Approval");
  addParamTags("product_id", "Product ID");
  addParamTags("po_number", "PO #");

  if (qHidden.value) {
    tags.push({ type: "q", key: "Keyword", value: qHidden.value, display: qHidden.value });
  }

  function renderTags(){
    tagsEl.innerHTML = "";
    tags.forEach((t, idx) => {
      const span = document.createElement("span");
      span.className = "bk-tag";
      span.innerHTML = `
        <span class="bk-tag-key">${t.key}:</span>
        <span class="bk-tag-val"></span>
        <button type="button" title="Remove">×</button>
      `;
      span.querySelector(".bk-tag-val").textContent = t.display;
      span.querySelector("button").addEventListener("click", () => {
        tags.splice(idx, 1);
        renderTags();
        syncHiddenInputs();
      });
      tagsEl.appendChild(span);
    });
  }

  function syncHiddenInputs(){
    hiddenEl.innerHTML = "";
    qHidden.value = "";

    tags.forEach(t => {
      if (t.type === "q") {
        qHidden.value = t.value;
        return;
      }
      const inp = document.createElement("input");
      inp.type = "hidden";
      inp.name = t.type;
      inp.value = t.value;
      hiddenEl.appendChild(inp);

      if (t.labelParam && t.display) {
        const lbl = document.createElement("input");
        lbl.type = "hidden";
        lbl.name = t.labelParam;
        lbl.value = t.display;
        hiddenEl.appendChild(lbl);
      }
    });
  }

  renderTags();
  syncHiddenInputs();

  // ---------- Suggestions ----------
  let debounceTimer = null;
  function showBox(html){
    box.innerHTML = html;
    box.style.display = html ? "block" : "none";
  }

  function escapeHtml(s){
    return (s || "").replace(/[&<>"']/g, c => ({
      "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"
    }[c]));
  }

  function addTagFromSuggestion(s){
    const exists = tags.some(t => t.type === s.type && t.value === s.value);
    if (!exists) {
      const keyMap = {
        paid_to: "Paid To",
        prepared_by: "Prepared By",
        status: "Status",
        approval_status: "Approval",
        product_id: "Product ID",
        po_number: "PO #",
        q: "Keyword",
      };
      tags.push({
        type: s.type,
        key: keyMap[s.type] || s.badge || "Filter",
        value: s.value,
        display: s.label,
        labelParam: `${s.type}_label`,
      });
      renderTags();
      syncHiddenInputs();
    }
    input.value = "";
    showBox("");
  }

  input.addEventListener("input", function(){
    const q = input.value.trim();
    if (!q) return showBox("");

    clearTimeout(debounceTimer);
    debounceTimer = setTimeout(() => {
      fetch(`/api/po/filter-suggestions/?q=${encodeURIComponent(q)}`)
        .then(r => r.json())
        .then(data => {
          if (!data.ok) return showBox("");
          const results = data.results || [];
          if (!results.length) return showBox("");

          const html = results.map(s => `
            <button type="button"
              class="list-group-item list-group-item-action py-1"
              data-type="${escapeHtml(s.type)}"
              data-value="${escapeHtml(s.value)}"
              data-label="${escapeHtml(s.label)}"
              data-badge="${escapeHtml(s.badge || "")}"
            >
              <span class="bk-suggestion-badge">${escapeHtml(s.badge || "")}</span>
              ${escapeHtml(s.label)}
            </button>
          `).join("");
          showBox(html);
        })
        .catch(() => showBox(""));
    }, 180);
  });

  box.addEventListener("click", function(e){
    const btn = e.target.closest("button");
    if (!btn) return;
    addTagFromSuggestion({
      type: btn.dataset.type,
      value: btn.dataset.value,
      label: btn.dataset.label,
      badge: btn.dataset.badge,
    });
  });

  // Enter selects first suggestion if present; else submit
  input.addEventListener("keydown", function(e){
    if (e.key !== "Enter") return;
    const first = box.querySelector("button");
    if (first) {
      e.preventDefault();
      first.click();
      return;
    }
    e.preventDefault();
    resetPage();
    syncHiddenInputs();
    form.submit();
  });

  document.addEventListener("click", function(e){
    if (!e.target.closest("#bk-global-search") && !e.target.closest("#bk-suggestions")) showBox("");
  });

  // ---------- Sort applies immediately ----------
  document.querySelectorAll("[data-sort]").forEach(btn => {
    btn.addEventListener("click", function(){
      sortHidden.value = this.dataset.sort;
      resetPage();
      syncHiddenInputs();
      form.submit();
    });
  });

  // ---------- Auto-apply hide checkboxes ----------
  form.querySelectorAll('input[name="hide_archived"], input[name="hide_cancelled"]').forEach(cb => {
    cb.addEventListener("change", function(){
      resetPage();
      syncHiddenInputs();
      form.submit();
    });
  });

  // ---------- Selection UX ----------
  function refreshSelectedFooter(){
    const summary = document.getElementById("po-footer-summary");
    if (!summary) return;

    const checked = Array.from(document.querySelectorAll(".po-checkbox:checked"));
    if (!checked.length) {
      summary.innerHTML = `
        Showing <strong>{{ page_obj.paginator.count }}</strong> PO(s) |
        Total: <strong>₱{{ total_sum|floatformat:2|intcomma }}</strong>
      `;
      return;
    }
    let total = 0;
    checked.forEach(cb => {
      const val = parseFloat(cb.dataset.total || 0);
      total += isNaN(val) ? 0 : val;
    });
    summary.innerHTML = `
      <strong>Selected ${checked.length} PO${checked.length > 1 ? "s" : ""}</strong>
      &nbsp;|&nbsp;
      Total: <strong>₱${total.toLocaleString("en-PH", { minimumFractionDigits: 2, maximumFractionDigits: 2 })}</strong>
    `;
  }

  const selectAll = document.getElementById("select-all");
  if (selectAll) {
    selectAll.addEventListener("change", function(){
      document.querySelectorAll(".po-checkbox").forEach(cb => {
        cb.checked = selectAll.checked;
        cb.closest("tr")?.classList.toggle("selected", cb.checked);
      });
      refreshSelectedFooter();
    });
  }

  document.querySelectorAll(".po-checkbox").forEach(cb => {
    cb.addEventListener("change", function(){
      cb.closest("tr")?.classList.toggle("selected", cb.checked);
      refreshSelectedFooter();
    });
  });

  document.addEventListener("click", function(e){
    const row = e.target.closest("tr.po-row");
    if (!row) return;
    if (e.target.closest("a") || e.target.closest("button") || e.target.closest("input")) return;

    const cb = row.querySelector(".po-checkbox");
    if (!cb) return;
    cb.checked = !cb.checked;
    row.classList.toggle("selected", cb.checked);
    refreshSelectedFooter();
    refreshPOBulkButton(); // ✅ ADD THIS
  });

});


function getSelectedPOIds() {
  return Array.from(document.querySelectorAll(".po-checkbox:checked"))
    .map(cb => cb.value);
}

function refreshPOBulkButton() {
  document.getElementById("poBulkActionsBtn").disabled =
    getSelectedPOIds().length === 0;
}

document.addEventListener("change", e => {
  if (e.target.classList.contains("po-checkbox") || e.target.id === "select-all") {
    refreshPOBulkButton();
  }
});
function poBulkOpen() {
  const ids = getSelectedPOIds();
  if (!ids.length) return;

  const firstId = ids[0];

  window.location.href =
    `/po/${firstId}/edit/?from=bulk&nav_ids=${ids.join(",")}`;
}

</script>


{% endblock %}
