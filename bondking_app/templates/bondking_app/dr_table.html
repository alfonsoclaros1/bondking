{% extends "base.html" %}
{% load static %}
{% load humanize %}
{% load dr_badges %}

{% block title %}Delivery Receipts Table{% endblock %}

{% block content %}
<div class="container-fluid py-3">

  <div class="d-flex align-items-center justify-content-between mb-3">
    <div>
      <h4 class="mb-0">Delivery Receipts</h4>
    </div>
    <div class="d-flex gap-2">
      <a href="{% url 'dr-kanban' %}" class="btn btn-outline-secondary btn-sm">Back to Dashboard</a>
      <a href="{% url 'dr-create' %}" class="btn btn-primary btn-sm">New DR</a>
    </div>
  </div>

  <!-- Filters -->
  <div class="card shadow-sm mb-3">
    <div class="card-body">
      <form method="get" class="row g-2 align-items-end">
        <!-- SMART SEARCH (GLOBAL) -->
        <div class="col-12">
          <label class="form-label small text-muted">Search</label>

          <div class="bk-search-wrap">
            <input
              type="text"
              class="form-control form-control-sm"
              id="bk-global-search"
              placeholder='Type to search (e.g., AGR, Delivered, Cash, 2025-0001)...'
              autocomplete="off"
            >

            <div id="bk-tags" class="bk-tags mt-2"></div>

            <!-- Suggestions -->
            <div
              id="bk-suggestions"
              class="list-group position-absolute w-100 shadow-sm"
              style="z-index: 1050; display:none; max-height: 280px; overflow-y:auto;"
            ></div>

            <!-- Hidden inputs container (tags written here before submit) -->
            <div id="bk-hidden-inputs"></div>

            <!-- Primary keyword (q) -->
            <input type="hidden" name="q" id="bk-q" value="{{ selected.q|default:'' }}">
            <input type="hidden" name="sort_by" id="bk-sort-by" value="{{ sort_by }}">
          </div>
        </div>

        <!-- MORE FILTERS TOGGLE -->
        <div class="col-12">
          <button
            type="button"
            class="btn btn-link p-0 small d-inline-flex align-items-center gap-1"
            id="bk-more-filters-btn"
          >
            <span id="bk-more-filters-text">More Filters</span>
            <i class="bi bi-chevron-down transition-icon" id="bk-more-filters-icon"></i>
          </button>
        </div>

        <!-- ADVANCED FILTERS (COLLAPSIBLE) -->
        <div class="col-12" id="bk-more-filters-panel" style="display:none;">
          <div class="row g-2 align-items-end mt-1">

            <div class="col-12 col-md-3">
              <label class="form-label small text-muted">Payment Status</label>
              <select name="payment_status" class="form-select form-select-sm">
                <option value="">All</option>
                {% for val, label in payment_statuses %}
                  <option value="{{ val }}">{{ label }}</option>
                {% endfor %}
              </select>
              <div class="form-text small text-muted">Use Smart Search for multiple.</div>
            </div>

            <div class="col-12 col-md-3">
              <label class="form-label small text-muted">Delivery Status</label>
              <select name="delivery_status" class="form-select form-select-sm">
                <option value="">All</option>
                {% for val,label in delivery_statuses %}
                  <option value="{{ val }}">{{ label }}</option>
                {% endfor %}
              </select>
              <div class="form-text small text-muted">Use Smart Search for multiple.</div>
            </div>

            <div class="col-12 col-md-3">
              <label class="form-label small text-muted">Payment Method</label>
              <select name="payment_method" class="form-select form-select-sm">
                <option value="">All</option>
                {% for val,label in payment_methods %}
                  <option value="{{ val }}">{{ label }}</option>
                {% endfor %}
              </select>
              <div class="form-text small text-muted">Use Smart Search for multiple.</div>
            </div>

            <div class="col-12 col-md-3">
              <label class="form-label small text-muted">Delivery Method</label>
              <select name="delivery_method" class="form-select form-select-sm">
                <option value="">All</option>
                {% for val,label in delivery_methods %}
                  <option value="{{ val }}">{{ label }}</option>
                {% endfor %}
              </select>
              <div class="form-text small text-muted">Use Smart Search for multiple.</div>
            </div>

            <div class="col-12 col-md-3">
              <label class="form-label small text-muted">Due Date (From)</label>
              <input type="date" name="due_start" class="form-control form-control-sm" value="{{ selected.due_start }}">
            </div>

            <div class="col-12 col-md-3">
              <label class="form-label small text-muted">Due Date (To)</label>
              <input type="date" name="due_end" class="form-control form-control-sm" value="{{ selected.due_end }}">
            </div>

            <div class="col-12 col-md-3">
              <label class="form-label small text-muted">Start Date</label>
              <input type="date" name="start_date" class="form-control form-control-sm" value="{{ selected.start_date }}">
            </div>

            <div class="col-12 col-md-3">
              <label class="form-label small text-muted">End Date</label>
              <input type="date" name="end_date" class="form-control form-control-sm" value="{{ selected.end_date }}">
            </div>

          </div>
        </div>

        <!-- ACTION ROW (UNCHANGED, but sort moved beside Export and before Actions) -->
        <div class="col-12 mt-3">
          <div class="d-flex flex-wrap align-items-center gap-3">

            <div class="d-flex gap-2">
              <button type="submit" class="btn btn-sm btn-primary">Apply Filters</button>
              <a href="{% url 'dr-table' %}" class="btn btn-sm btn-outline-secondary">Reset</a>
            </div>
            <a href="{% url 'dr-table-export' %}?{{ request.GET.urlencode }}" class="btn btn-sm btn-outline-success">
              Export to Excel
            </a>

            <!-- SORT DROPDOWN BUTTON (BESIDE EXPORT, BEFORE ACTIONS) -->
            <div class="dropdown">
              <button class="btn btn-sm btn-outline-secondary dropdown-toggle" type="button" data-bs-toggle="dropdown">
                Sort
              </button>
              <ul class="dropdown-menu">
                <li><button type="button" class="dropdown-item" data-sort="date_desc">Date (Newest first)</button></li>
                <li><button type="button" class="dropdown-item" data-sort="date_asc">Date (Oldest first)</button></li>
                <li><button type="button" class="dropdown-item" data-sort="total_desc">Total (High â†’ Low)</button></li>
                <li><button type="button" class="dropdown-item" data-sort="total_asc">Total (Low â†’ High)</button></li>
                <li><button type="button" class="dropdown-item" data-sort="dr_desc">DR Number (Descending)</button></li>
                <li><button type="button" class="dropdown-item" data-sort="dr_asc">DR Number (Ascending)</button></li>
              </ul>
            </div>

            <!-- Existing Actions dropdown stays -->
             <div class="dropdown">
                <button
                  class="btn btn-sm btn-outline-primary dropdown-toggle"
                  type="button"
                  data-bs-toggle="dropdown"
                  id="bulkActionsBtn"
                  disabled
                >
                  Actions
                </button>

                <ul class="dropdown-menu">
                  <li>
                    <button type="button" class="dropdown-item" onclick="bulkOpen()">Open</button>
                  </li>

                  {% if is_top_management %}
                    <li><hr class="dropdown-divider"></li>
                    <li>
                      <button type="button" class="dropdown-item text-warning" onclick="bulkArchive()">Archive</button>
                    </li>
                    <li>
                      <button type="button" class="dropdown-item text-danger" onclick="bulkCancel()">Cancel</button>
                    </li>
                  {% endif %}

                  {% if request.user.groups.all.0.name == "AGR" %}
                    <li><hr class="dropdown-divider"></li>
                    <li>
                      <button type="button" class="dropdown-item text-danger" onclick="bulkDelete()">Delete</button>
                    </li>
                  {% endif %}
                </ul>
              </div>
            <!-- INLINE FILTER CHECKBOXES -->
            <div class="d-flex align-items-center gap-3 ms-2">
              <div class="form-check form-check-inline mb-0">
                <input
                  class="form-check-input"
                  type="checkbox"
                  name="hide_archived"
                  value="1"
                  {% if hide_archived %}checked{% endif %}
                >
                <label class="form-check-label small text-muted">
                  Hide Archived
                </label>
              </div>

              <div class="form-check form-check-inline mb-0">
                <input
                  class="form-check-input"
                  type="checkbox"
                  name="hide_cancelled"
                  value="1"
                  {% if hide_cancelled %}checked{% endif %}
                >
                <label class="form-check-label small text-muted">
                  Hide Cancelled
                </label>
              </div>

              <div class="form-check form-check-inline mb-0">
                <input
                  class="form-check-input"
                  type="checkbox"
                  name="with_sales_invoice"
                  value="1"
                  {% if selected.with_sales_invoice %}checked{% endif %}
                >
                <label class="form-check-label small text-muted">
                  Sales Invoice Only
                </label>
              </div>
            </div>


          </div>
        </div>

      </form>
    </div>
  </div>

  <!-- Table -->
  <div class="card shadow-sm">
    <div class="card-body p-0">
        <table class="table table-hover align-middle mb-0 dr-table">
          <thead class="table-light" style="position: sticky; top: 0; z-index: 1;">
            <tr>    
              <th class="ps-3">
                <input type="checkbox" id="select-all">
              </th>
              <th class="ps-3">DR #</th>
              <th>Date</th>
              <th>Client</th>
              <th>Agent</th>
              <th>Items</th>
              <th>Payment Status</th>
              <th>Payment Method</th>
              <th>Delivery Status</th>
              <th>Total</th>
            </tr>
          </thead>
          <tbody>
            {% for dr in page_obj %}
              <tr
                class="dr-row
                  {% if dr.is_cancelled %}table-danger
                  {% elif dr.is_archived %}table-success
                  {% endif %}
                "
                data-dr-id="{{ dr.id }}"
                data-edit-url="{% url 'dr-edit' dr.id %}?from=table&{{ request.GET.urlencode }}"
              >
                <td class="ps-3">
                  <input
                    type="checkbox"
                    class="dr-checkbox"
                    value="{{ dr.id }}"
                    data-total="{{ dr.total_amount }}"
                    onclick="event.stopPropagation();"
                  >
                </td>
                <td>
                  <a href="{% url 'dr-edit' dr.id %}?from=table&{{ request.GET.urlencode }}" class="text-decoration-none fw-semibold">
                    {{ dr.dr_number }}
                  </a>
                  {% if dr.sales_invoice_no %}
                    <span class="badge bg-info ms-2">SI</span>
                  {% endif %}

                  {% if dr.is_cancelled %}
                    <span class="badge bg-danger ms-2">Cancelled</span>
                  {% elif dr.is_archived %}
                    <span class="badge bg-success ms-2">Archived</span>
                  {% endif %}
                </td>

                <td class="text-muted small">{{ dr.date_of_order|date:"Y-m-d" }}</td>

                <!-- Client: clickable, opens modal -->
                <td>
                  <button
                    type="button"
                    class="btn btn-link p-0 text-decoration-none btn-client"
                    data-client-id="{{ dr.client.id }}"
                    data-client-name="{{ dr.client.company_name }}"
                  >
                    {{ dr.client.company_name }}
                  </button>
                </td>

                <td class="small">{{ dr.agent.get_full_name|default:dr.agent.username }}</td>

                <!-- Items: show first item + commas, clickable for modal -->
                <td class="items-cell">
                  <button
                    type="button"
                    class="btn btn-link p-0 text-decoration-none btn-items text-start"
                    data-dr-id="{{ dr.id }}"
                    data-delivery-method="{{ dr.delivery_method }}"
                  >

                    {% with items=dr.items.all %}
                      {% if items %}
                        {% for it in items %}
                          {{ it.product.name }}{% if not forloop.last %}, {% endif %}
                        {% endfor %}
                      {% else %}
                        â€”
                      {% endif %}
                    {% endwith %}
                  </button>
                </td>

                <!-- Items -->

                <!-- Payment Status -->
                <td>
                  <span class="badge {{ dr.payment_status|payment_badge }}">
                    {{ dr.get_payment_status_display }}
                  </span>
                </td>

                <!-- Payment Method -->
                <td class="small">{{ dr.get_payment_method_display }}</td>

                <!-- Delivery Status -->
                <td>
                  <span class="badge {{ dr.delivery_status|delivery_badge }}">
                    {{ dr.get_delivery_status_display }}
                  </span>
                </td>

                <td class="fw-semibold">â‚±{{ dr.total_amount|floatformat:2|intcomma }}</td>
              </tr>
            {% empty %}
              <tr>
                <td colspan="9" class="text-center text-muted py-4">No delivery receipts found.</td>
              </tr>
            {% endfor %}
          </tbody>


        </table>
    </div>
    <!-- PAGINATION (BOTTOM) -->
    <div class="dr-table-footer d-flex justify-content-between align-items-center px-3 py-2 border-top">

      <!-- LEFT: SUMMARY -->
      <div class="small text-muted" id="dr-footer-summary">
        Showing <strong>{{ page_obj.paginator.count }}</strong> DR(s) |
        Total: <strong>â‚±{{ total_sum|floatformat:2|intcomma }}</strong>
      </div>
      <!-- RIGHT: PAGINATION -->
      <div class="d-flex align-items-center gap-2">
        <span class="small text-muted">
          Page {{ page_obj.number }} of {{ page_obj.paginator.num_pages }}
        </span>

        <nav aria-label="DR table pagination">
          <ul class="pagination pagination-sm mb-0">
            {% if page_obj.has_previous %}
              <li class="page-item">
                <a class="page-link"
                  href="?{% querystring page=page_obj.previous_page_number %}">
                  â€¹
                </a>
              </li>
            {% endif %}

            {% if page_obj.has_next %}
              <li class="page-item">
                <a class="page-link"
                  href="?{% querystring page=page_obj.next_page_number %}">
                  â€º
                </a>
              </li>
            {% endif %}
          </ul>
        </nav>
      </div>

    </div>


  </div>

</div>

<!-- Client modal -->
<div class="modal fade" id="clientModal" tabindex="-1">
  <div class="modal-dialog modal-lg modal-dialog-centered modal-dialog-scrollable">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="clientModalTitle">Client</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body" id="clientModalBody">
        <div class="text-muted">Loadingâ€¦</div>
      </div>
    </div>
  </div>
</div>
<!-- HQ STOCKS TRANSACTIONS MODAL -->
<div class="modal fade" id="hqTransactionsModal" tabindex="-1">
  <div class="modal-dialog modal-lg modal-dialog-centered modal-dialog-scrollable">
    <div class="modal-content">

      <div class="modal-header">
        <h5 class="modal-title">HQ Stock Transactions</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>

      <div class="modal-body">
        <div id="hq-transactions-content">
          <div class="text-center text-muted">
            Loadingâ€¦
          </div>
        </div>
      </div>

      <div class="modal-footer justify-content-between">
        <div id="hq-archive-container"></div>
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
          Close
        </button>
      </div>

    </div>
  </div>
</div>


<!-- Items modal -->
<div class="modal fade" id="itemsModal" tabindex="-1">
  <div class="modal-dialog modal-lg modal-dialog-centered modal-dialog-scrollable">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="itemsModalTitle">Items</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body" id="itemsModalBody">
        <div class="text-muted">Loadingâ€¦</div>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block extra_js %}

<script>

function resetPage() {
  const pageInputs = document.querySelectorAll('input[name="page"]');
  pageInputs.forEach(i => i.remove());
}

document.addEventListener("DOMContentLoaded", function () {
  const form = document.querySelector("form");
  const input = document.getElementById("bk-global-search");
  const box = document.getElementById("bk-suggestions");
  const tagsEl = document.getElementById("bk-tags");
  const hiddenEl = document.getElementById("bk-hidden-inputs");
  const qHidden = document.getElementById("bk-q");
  const sortHidden = document.getElementById("bk-sort-by");

  if (!form || !input || !box || !tagsEl || !hiddenEl) return;

  // ---------------------------
  // More Filters (remember state)
  // ---------------------------
  const moreBtn = document.getElementById("bk-more-filters-btn");
  const morePanel = document.getElementById("bk-more-filters-panel");
  const LS_KEY = "dr_table_more_filters_open";

function setMoreFilters(open) {
  if (!morePanel) return;

  const textEl = document.getElementById("bk-more-filters-text");
  const iconEl = document.getElementById("bk-more-filters-icon");

  if (open) {
    morePanel.style.display = "";
    morePanel.style.maxHeight = morePanel.scrollHeight + "px";
    morePanel.style.opacity = "1";
    textEl.textContent = "Less Filters";
    iconEl.classList.add("rotated");
  } else {
    morePanel.style.maxHeight = "0px";
    morePanel.style.opacity = "0";
    textEl.textContent = "More Filters";
    iconEl.classList.remove("rotated");

    // allow animation before hiding
    setTimeout(() => {
      if (!localStorage.getItem(LS_KEY) || localStorage.getItem(LS_KEY) === "0") {
        morePanel.style.display = "none";
      }
    }, 250);
  }

  localStorage.setItem(LS_KEY, open ? "1" : "0");
}


  if (moreBtn && morePanel) {
    const initialOpen = localStorage.getItem(LS_KEY) === "1";
    setMoreFilters(initialOpen);

    moreBtn.addEventListener("click", () => {
      const isOpen = morePanel.style.display !== "none";
      setMoreFilters(!isOpen);
    });
  }

  // ---------------------------
  // Tags state (from query params)
  // ---------------------------
  const tags = [];

  const params = new URLSearchParams(window.location.search);

  function addParamTags(param, type, key) {
    const values = params.getAll(param);
    const labels = params.getAll(`${param}_label`);

    values
      .map(v => v.trim())
      .filter(v => v !== "")
      .forEach((v, i) => {
        tags.push({
          type,
          key,
          value: v,
          label: labels[i] || v,     // fallback if missing
          display: labels[i] || v,
          labelParam: `${param}_label`,
        });
      });
  }


  addParamTags("agent", "agent", "Agent");
  addParamTags("client_name", "client_name", "Client");
  addParamTags("dr_number", "dr_number", "DR #");
  addParamTags("payment_status", "payment_status", "Payment Status");
  addParamTags("delivery_status", "delivery_status", "Delivery Status");
  addParamTags("payment_method", "payment_method", "Payment Method");
  addParamTags("delivery_method", "delivery_method", "Delivery Method");

  if (qHidden && qHidden.value) {
    tags.push({ type: "q", key: "Keyword", value: qHidden.value, label: qHidden.value });
  }

  function renderTags() {
    tagsEl.innerHTML = "";
    tags.forEach((t, idx) => {
      const tag = document.createElement("span");
      tag.className = "bk-tag";
      tag.innerHTML = `
        <span class="bk-tag-key">${t.key}:</span>
        <span class="bk-tag-val"></span>
        <button type="button" title="Remove">Ã—</button>
      `;
      tag.querySelector(".bk-tag-val").textContent = t.display || t.label;
      tag.querySelector("button").addEventListener("click", () => {
        tags.splice(idx, 1);
        renderTags();
      });
      tagsEl.appendChild(tag);
    });
  }

  function syncHiddenInputs() {
    hiddenEl.innerHTML = "";

    // clear q hidden; re-add if present in tags
    if (qHidden) qHidden.value = "";

    tags.forEach(t => {
      if (t.type === "q") {
        if (qHidden) qHidden.value = t.value;
        return;
      }

      // value param (ID)
      const inp = document.createElement("input");
      inp.type = "hidden";
      inp.name = t.type;
      inp.value = t.value;
      hiddenEl.appendChild(inp);

      // label param (human-readable)
      if (t.labelParam && t.display) {
        const lbl = document.createElement("input");
        lbl.type = "hidden";
        lbl.name = t.labelParam;
        lbl.value = t.display;
        hiddenEl.appendChild(lbl);
      }

    });
  }

  renderTags();
  syncHiddenInputs();

  // Ensure tags persist across ALL submits (including checkbox auto-submit)
  form.addEventListener("submit", function () {
    resetPage();
    syncHiddenInputs();
  });

  // ---------------------------
  // Suggestions (API-backed; complete across all DRs)
  // ---------------------------
  let lastQuery = "";
  let debounceTimer = null;

  function showBox(html) {
    box.innerHTML = html;
    box.style.display = html ? "block" : "none";
  }

  function escapeHtml(s) {
    return (s || "").replace(/[&<>"']/g, c => ({
      "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"
    }[c]));
  }

  function addTagFromSuggestion(s) {
    // Prevent duplicates of identical (type+value)
    const exists = tags.some(t => t.type === s.type && t.value === s.value);
    if (!exists) {
      const keyMap = {
        agent: "Agent",
        client_name: "Client",
        dr_number: "DR #",
        payment_status: "Payment Status",
        delivery_status: "Delivery Status",
        payment_method: "Payment Method",
        delivery_method: "Delivery Method",
        q: "Keyword",
      };
      tags.push({
        type: s.type,
        key: keyMap[s.type] || s.badge || "Filter",
        value: s.value,
        label: s.label,
        display: s.label,
        labelParam: `${s.type}_label`,
      });
      renderTags();
      syncHiddenInputs();
    }

    input.value = "";
    showBox("");
  }

  input.addEventListener("input", function () {
    const q = input.value.trim();
    if (!q) {
      showBox("");
      return;
    }

    clearTimeout(debounceTimer);
    debounceTimer = setTimeout(() => {
      if (q === lastQuery) return;
      lastQuery = q;

      fetch(`/api/dr/filter-suggestions/?q=${encodeURIComponent(q)}`)
        .then(r => r.json())
        .then(data => {
          if (!data.ok) return showBox("");

          const results = data.results || [];
          if (!results.length) return showBox("");

          const html = results.map(s => `
            <button type="button"
              class="list-group-item list-group-item-action py-1"
              data-type="${escapeHtml(s.type)}"
              data-value="${escapeHtml(s.value)}"
              data-label="${escapeHtml(s.label)}"
              data-badge="${escapeHtml(s.badge || "")}"
            >
              <span class="bk-suggestion-badge">${escapeHtml(s.badge || "")}</span>
              ${escapeHtml(s.label)}
            </button>
          `).join("");

          showBox(html);
        })
        .catch(() => showBox(""));
    }, 180);
  });

  box.addEventListener("click", function (e) {
    const btn = e.target.closest("button");
    if (!btn) return;

    addTagFromSuggestion({
      type: btn.dataset.type,
      value: btn.dataset.value,
      label: btn.dataset.label,
      badge: btn.dataset.badge,
    });
  });

  input.addEventListener("keydown", function (e) {
    if (e.key !== "Enter") return;

    const active =
      box.querySelector(".active") ||
      box.querySelector("button");

    if (active) {
      e.preventDefault();

      addTagFromSuggestion({
        type: active.dataset.type,
        value: active.dataset.value,
        label: active.dataset.label,
        badge: active.dataset.badge,
      });
      return;
    }

    // fallback: submit normally
    e.preventDefault();
    
    resetPage();
    syncHiddenInputs();
    form.submit();
  });


  document.addEventListener("click", function (e) {
    if (!e.target.closest("#bk-global-search") && !e.target.closest("#bk-suggestions")) {
      showBox("");
    }
  });

  // ---------------------------
  // Sort dropdown button -> set hidden sort_by then wait for Apply
  // (You requested: no separate sort select)
  // ---------------------------
  document.querySelectorAll("[data-sort]").forEach(btn => {
    btn.addEventListener("click", function () {
      if (sortHidden) sortHidden.value = this.dataset.sort;

      // ðŸ”¥ immediately apply sort
      
      resetPage();
      syncHiddenInputs();
      form.submit();
    });
  });
});
</script>

<script>
document.addEventListener("click", function(e) {

  /* =======================
     CLIENT MODAL
     ======================= */
  const clientBtn = e.target.closest(".btn-client");
  if (clientBtn) {
    const clientId = clientBtn.dataset.clientId;
    const clientName = clientBtn.dataset.clientName;

    const modalEl = document.getElementById("clientModal");
    const modal = new bootstrap.Modal(modalEl);

    document.getElementById("clientModalTitle").textContent = clientName;
    const body = document.getElementById("clientModalBody");
    body.innerHTML = `<div class="text-muted">Loadingâ€¦</div>`;

    fetch(`/api/clients/${clientId}/`)
      .then(r => r.json())
      .then(data => {
        body.innerHTML = `
          <div class="row g-3">
            <div class="col-md-6">
              <div class="small text-muted">Company</div>
              <div class="fw-semibold">${data.company_name || "â€”"}</div>
            </div>
            <div class="col-md-6">
              <div class="small text-muted">Owner</div>
              <div>${data.name_of_owner || "â€”"}</div>
            </div>
            <div class="col-md-6">
              <div class="small text-muted">Contact</div>
              <div>${data.contact_number || "â€”"}</div>
            </div>
            <div class="col-md-6">
              <div class="small text-muted">Address</div>
              <div>${data.full_address || "â€”"}</div>
            </div>
          </div>
        `;
      })
      .catch(() => {
        body.innerHTML = `<div class="text-danger">Failed to load client details.</div>`;
      });

    modal.show();
    return;
  }
    /* =======================
     ITEMS / HQ HANDLER
     ======================= */
  const itemsBtn = e.target.closest(".btn-items");
  if (itemsBtn) {
    const drId = itemsBtn.dataset.drId;
    const drNumber = itemsBtn.dataset.drNumber;
    const deliveryMethod = itemsBtn.dataset.deliveryMethod;

    // --------------------------
    // HQ STOCKS â†’ HQ POPUP
    // --------------------------
    if (deliveryMethod === "HQ_STOCKS") {
        openHQTransactions(drId);
        return;
    }

    // --------------------------
    // NORMAL DR â†’ ITEMS MODAL
    // --------------------------
    const modalEl = document.getElementById("itemsModal");
    const modal = new bootstrap.Modal(modalEl);

    document.getElementById("itemsModalTitle").textContent =
      `Items for ${drNumber}`;

    const body = document.getElementById("itemsModalBody");
    body.innerHTML = `<div class="text-muted">Loadingâ€¦</div>`;
    function formatCurrency(value) {
      const num = Number(value || 0);
      return num.toLocaleString("en-PH", {
        minimumFractionDigits: 2,
        maximumFractionDigits: 2
      });
    }
    fetch(`/api/dr/${drId}/items/`)
      .then(r => r.json())
      .then(data => {
        if (!data.ok) throw new Error();

        body.innerHTML = `
          <div class="table-responsive">
            <table class="table table-sm align-middle">
              <thead>
                <tr>
                  <th>Product</th>
                  <th>Description</th>
                  <th>Qty</th>
                  <th>Unit</th>
                  <th>Total</th>
                </tr>
              </thead>
              <tbody>
                ${data.items.map(it => `
                  <tr>
                    <td class="fw-semibold">${it.product}</td>
                    <td class="small">${it.description || "â€”"}</td>
                    <td>${it.quantity}</td>
                    <td>â‚±${formatCurrency(it.unit_price)}</td>
                    <td>â‚±${formatCurrency(it.line_total)}</td>
                  </tr>
                `).join("")}
              </tbody>
            </table>
          </div>
        `;
      })
      .catch(() => {
        body.innerHTML = `<div class="text-danger">Failed to load items.</div>`;
      });

    modal.show();
    return;
  }


});

</script>
<style>
.items-cell {
  max-width: 320px;
  white-space: normal;
  word-break: break-word;
}

.items-cell .btn-link {
  text-align: left;
  white-space: normal;
  padding: 0;
}
table td {
  text-align: left;
  vertical-align: top;
}
.badge {
  font-weight: 500;
  padding: 0.4em 0.6em;
}
tr.table-danger td {
  text-decoration: line-through;
  opacity: 0.75;
}
tr.table-danger td {
  text-decoration: line-through;
  opacity: 0.75;
}

tr.table-danger td a,
tr.table-danger td button {
  text-decoration: none;
}
tr.dr-row.selected {
  background-color: rgba(13,110,253,0.08);
}
.dr-table-footer {
  position: sticky;
  bottom: 0;
  background: #fff;
  z-index: 5;
}

.dr-table thead th {
  position: sticky;
  top: 0;
  z-index: 3;
  background: #fff;
  border-bottom: 2px solid #dee2e6;
}

/* Ensure header doesn't overlap footer */
.dr-table-footer {
  z-index: 5;
}

</style>
<style>
.bk-search-wrap { position: relative; }
.bk-tags { display: flex; flex-wrap: wrap; gap: 6px; }
.bk-tag {
  display: inline-flex;
  align-items: center;
  gap: 6px;
  padding: 4px 10px;
  border-radius: 999px;
  background: rgba(13,110,253,0.08);
  border: 1px solid rgba(13,110,253,0.18);
  font-size: 12px;
}
.bk-tag .bk-tag-key { font-weight: 600; color: #0d6efd; }
.bk-tag .bk-tag-val { color: #212529; }
.bk-tag button {
  border: none;
  background: transparent;
  padding: 0;
  line-height: 1;
  cursor: pointer;
  color: #6c757d;
}
.bk-suggestion-badge {
  font-size: 11px;
  border-radius: 999px;
  padding: 2px 8px;
  border: 1px solid rgba(0,0,0,.1);
  background: #f8f9fa;
  margin-right: 8px;
}

/* More / Less filters animation */
#bk-more-filters-panel {
  overflow: hidden;
  transition: max-height 0.25s ease, opacity 0.2s ease;
}

.transition-icon {
  transition: transform 0.25s ease;
}

.transition-icon.rotated {
  transform: rotate(180deg);
}

</style>
<script>
document.addEventListener("DOMContentLoaded", function () {

  const form = document.querySelector('form[method="get"]');
  if (!form) return;

  const checkboxes = form.querySelectorAll(
    'input[name="hide_archived"], input[name="hide_cancelled"], input[name="with_sales_invoice"]'
  );

  checkboxes.forEach(cb => {
    cb.addEventListener("change", function () {

      // ðŸ”¹ Remove page param so results reset to page 1
      const pageInputs = form.querySelectorAll('input[name="page"]');
      pageInputs.forEach(p => p.remove());

      // ðŸ”¹ If smart-search tags exist, sync them
      if (typeof window.syncHiddenInputs === "function") {
        window.syncHiddenInputs();
      }

      // ðŸ”¹ Submit immediately
      form.submit();
    });
  });

});
</script>

<script>
document.addEventListener("DOMContentLoaded", function () {
  const form = document.querySelector("form");
  const drInput = document.getElementById("dr-search");
  const drHidden = document.getElementById("dr-number-hidden");

  if (!form || !drInput || !drHidden) return;

  form.addEventListener("submit", function () {
    // âœ… If user typed but didn't click suggestion,
    // sync visible value into hidden field
    if (!drHidden.value && drInput.value.trim()) {
      drHidden.value = drInput.value.trim();
    }
  });
});
</script>
<script>
document.addEventListener("DOMContentLoaded", function () {
  const form = document.querySelector("form");
  if (!form) return;

  form.addEventListener("submit", function () {
    const clientId = document.getElementById("client-id");
    const clientName = document.getElementById("client-name");
    const clientSearch = document.getElementById("client-search");

    if (!clientId || !clientName || !clientSearch) return;

    // âœ… If a client ID is selected, CLEAR client_name
    if (clientId.value) {
      clientName.value = "";
      return;
    }

    // âœ… If no ID, but text exists, use it as client_name
    if (clientSearch.value.trim()) {
      clientName.value = clientSearch.value.trim();
    } else {
      clientName.value = "";
    }
  });
});
</script>
<script>
document.addEventListener("DOMContentLoaded", function () {
  const selectAll = document.getElementById("select-all");

  selectAll?.addEventListener("change", function () {
    document.querySelectorAll(".dr-checkbox").forEach(cb => {
      cb.checked = this.checked;
      cb.closest("tr").classList.toggle("selected", cb.checked);
      updateSelectedFooter();
    });
  });

  document.querySelectorAll(".dr-checkbox").forEach(cb => {
    cb.addEventListener("change", function () {
      this.closest("tr").classList.toggle("selected", this.checked);
      updateSelectedFooter();
    });
  });
});
</script>

<script>
function getSelectedIds() {
  return Array.from(document.querySelectorAll(".dr-checkbox:checked"))
    .map(cb => cb.value);
}

function refreshBulkButton() {
  document.getElementById("bulkActionsBtn").disabled =
    getSelectedIds().length === 0;
}

document.addEventListener("change", e => {
  if (e.target.classList.contains("dr-checkbox") || e.target.id === "select-all") {
    refreshBulkButton();
  }
});
</script>
<script>

function bulkOpen() {
  const checkboxes = Array.from(
    document.querySelectorAll(".dr-checkbox:checked")
  );

  if (!checkboxes.length) return;

  // Preserve visual table order
  const ids = checkboxes.map(cb => cb.value);

  const firstId = ids[0];

  window.location.href =
    `/dr/${firstId}/edit/?from=table&nav_ids=${ids.join(",")}`;
}


</script>
<script>
function bulkArchive() {
  const ids = getSelectedIds();
  if (!confirm(`Archive ${ids.length} DR(s)?`)) return;

  ids.forEach(id => {
    fetch(`/dr/${id}/archive/`, {
      method: "POST",
      headers: { "X-CSRFToken": getCookie("csrftoken") }
    });
  });

  setTimeout(() => location.reload(), 500);
}
</script>
<script>
function bulkCancel() {
  const ids = getSelectedIds();
  if (!confirm(`Cancel ${ids.length} DR(s)?`)) return;

  ids.forEach(id => {
    fetch(`/dr/${id}/cancel/`, {
      method: "POST",
      headers: { "X-CSRFToken": getCookie("csrftoken") }
    });
  });

  setTimeout(() => location.reload(), 500);
}
</script>
<script>
function bulkDelete() {
  const ids = getSelectedIds();
  if (!confirm(`DELETE ${ids.length} DR(s)? This is permanent.`)) return;

  ids.forEach(id => {
    fetch(`/dr/${id}/delete/`, {
      method: "POST",
      headers: {
        "X-CSRFToken": getCookie("csrftoken"),
        "Content-Type": "application/x-www-form-urlencoded"
      },
      body: `confirm_text=${id}`
    });
  });

  setTimeout(() => location.reload(), 700);
}
</script>
<script>
document.addEventListener("click", function (e) {
  const row = e.target.closest("tr.dr-row");
  if (!row) return;

  // Ignore clicks on interactive elements
  if (
    e.target.closest("a") ||
    e.target.closest("button") ||
    e.target.closest("input")
  ) return;

  const checkbox = row.querySelector(".dr-checkbox");
  if (!checkbox) return;

  checkbox.checked = !checkbox.checked;
  row.classList.toggle("selected", checkbox.checked);

  refreshBulkButton();
  updateSelectedFooter();
});
</script>
<script>
function updateSelectedFooter() {
  const summary = document.getElementById("dr-footer-summary");
  if (!summary) return;

  const checked = Array.from(
    document.querySelectorAll(".dr-checkbox:checked")
  );

  if (checked.length === 0) {
    summary.innerHTML = `
      Showing <strong>{{ page_obj.paginator.count }}</strong> DR(s) |
      Total: <strong>â‚±{{ total_sum|floatformat:2|intcomma }}</strong>
    `;
    return;
  }

  let total = 0;
  checked.forEach(cb => {
    const val = parseFloat(cb.dataset.total || 0);
    total += isNaN(val) ? 0 : val;
  });

  summary.innerHTML = `
    <strong>Selected ${checked.length} DR${checked.length > 1 ? "s" : ""}</strong>
    &nbsp;|&nbsp;
    Total: <strong>â‚±${total.toLocaleString("en-PH", {
      minimumFractionDigits: 2,
      maximumFractionDigits: 2
    })}</strong>
  `;
}
</script>



{% endblock %}
