{% extends "base.html" %}

{% block title %}{% if is_create %}New PO{% else %}Edit PO{% endif %}{% endblock %}

{% block content %}
<div class="container py-3" style="max-width: 1100px;">
  <div class="d-flex justify-content-between align-items-center mb-3">
    <!-- LEFT: Title -->
    <div>
      <h4 class="mb-0">
        {% if is_create %}New Purchase Order{% else %}Edit Purchase Order{% endif %}
      </h4>
      <small class="text-muted">Stage: {{ stage }}</small>
    </div>

    <!-- RIGHT: Navigation buttons -->
    <div class="d-flex align-items-center gap-2">
      <a href="{% url 'po-table' %}" class="btn btn-outline-secondary btn-sm">
        Back to Table
      </a>

      {% if prev_po %}
        <a
          href="{% url 'po-edit' prev_po.id %}?{{ nav_querystring }}"
          class="btn btn-sm btn-outline-secondary"
        >
          Prev
        </a>
      {% endif %}

      {% if next_po %}
        <a
          href="{% url 'po-edit' next_po.id %}?{{ nav_querystring }}"
          class="btn btn-sm btn-outline-secondary"
        >
          Next
        </a>
      {% endif %}
    </div>
  </div>


  <form method="post" novalidate>
    {% csrf_token %}
    <div class="row g-3">
      <div class="col-md-3">
        <div class="card">
          <div class="card-header py-2">
            <strong>PO Lifecycle</strong>
          </div>

          <ul class="list-group list-group-flush small po-lifecycle">
            {% for step in po_flow %}
            <li class="list-group-item d-flex align-items-center
                {% if step.is_current %} po-step-active {% endif %}
                {% if step.is_done %} po-step-complete {% endif %}
                {% if po.approval_status == 'DECLINED' and step.is_current %} po-step-declined {% endif %}
                {% if po.is_archived and step.is_current %} po-step-archived {% endif %}
            ">

              <!-- Left icon -->
              <span class="me-2 po-step-icon">
                {% if step.is_done %}
                  ✓
                {% elif step.is_current %}
                  ●
                {% else %}
                  ○
                {% endif %}
              </span>

              <!-- Label -->
              <span class="po-step-label">
                {{ step.label }}
              </span>

            </li>
            {% endfor %}
          </ul>
        </div>
      </div>

    <!-- Next Step Card -->
    <div class="col-md-9">
          {% if not is_create and po.status != 'REQUEST_FOR_PAYMENT' %}
      <div class="card mb-3
        {% if po.is_archived %}border-success
        {% elif po.approval_status == 'DECLINED' or po.is_cancelled %}border-danger
        {% else %}border-warning{% endif %}
      ">
        <div class="card-body">

          <h6 class="mb-1">
            {% if po.is_archived %}
              Archived
            {% elif po.approval_status == 'DECLINED' %}
              Action Required
            {% else %}
              Awaiting {{ next_actor }}
            {% endif %}
          </h6>

          <p class="small text-muted mb-2">
            {{ next_step_description }}
          </p>

          <div class="d-flex gap-2">
            {% if can_approve %}
              <button name="action" value="approve" class="btn btn-sm btn-success">Approve</button>
              <button name="action" value="decline" class="btn btn-sm btn-danger">Decline</button>
            {% endif %}

            {% if can_submit %}
              <button name="action" value="submit" class="btn btn-sm btn-primary">
                {{ submit_label }}
              </button>
            {% endif %}

            {% if can_archive %}
              <button name="action" value="archive" class="btn btn-sm btn-success">
                Archive
              </button>
            {% endif %}
          </div>

        </div>
      </div>
      {% endif %}


    <!-- PO HEADER -->
    <div class="card mb-4">
      <div class="card-header py-2">
        <strong>PO Header</strong>
      </div>
      <div class="card-body">
        <div class="row g-3 align-items-center">

          <div class="col-md-4">
            <label class="form-label mb-1">Paid To</label>
            {{ form.paid_to }}
          </div>

          <div class="col-md-2">
            <label class="form-label mb-1">Date</label>
            {{ form.date }}
          </div>
          <div class="col-md-4">
            <label class="form-label">RFP Number</label>
            {{ form.rfp_number }}
          </div>
          <div class="col-md-3">
            <label class="form-label mb-1">PO Number</label>
            {{ form.po_number }}
          </div>
          <div class="col-md-4">
            <label class="form-label mb-1">Product ID</label>

            <div class="input-group">
              {{ form.product_id_ref }}

              <button
                type="button"
                class="btn btn-outline-secondary"
                id="add-product-id-btn"
                title="Add Product ID"
              >
                +
              </button>
            </div>
          </div>

          <!-- Address row -->
          <div class="col-12 mt-2">
            <div class="row g-2 align-items-center">
              <div class="col-md-2">
                <label class="form-label mb-0">Address</label>
              </div>
              <div class="col-md-10">
                {{ form.address }}
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- PARTICULARS -->
    <div class="card mb-4">
      <div class="card-header py-2">
        <strong>Particulars</strong>
      </div>
      <div class="card-body">

        {{ formset.management_form }}

        <div class="table-responsive">
          <table class="table table-sm align-middle mb-0">
            <thead class="table-light">
              <tr>
                <!-- Particular takes remaining space -->
                <th class="text-start">Particular</th>

                <!-- Fixed, readable numeric columns -->
                <th class="text-end" style="width: 90px;">Qty</th>
                <th class="text-end" style="width: 150px;">Unit Price</th>
                <th class="text-end" style="width: 160px;">Line Total</th>
              </tr>
            </thead>

            <tbody>
              {% for f in formset.forms %}
              {{ f.id }}
              <tr>
                <!-- Particular MUST fill column -->
                <td>
                  {{ f.particular }}
                </td>

                <td class="text-end">
                  {{ f.quantity }}
                </td>

                <td class="text-end">
                  {{ f.unit_price }}
                </td>

                <td class="text-end fw-medium align-middle">
                  ₱ <span class="line-total">0.00</span>
                </td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>

        <!-- SUBTOTAL -->
        <div class="d-flex justify-content-end mt-2">
          <div class="fw-semibold">
            Subtotal: ₱<span id="po-subtotal">0.00</span>
          </div>
        </div>

      </div>
    </div>
    <!-- BILLINGS -->
    <div class="card mb-4">
      <div class="card-header py-2 d-flex justify-content-between align-items-center">
        <strong>Billings</strong>

        <div class="d-flex align-items-center gap-2">
          <div class="small text-muted">
            Total Billed: ₱{{ billed_total|floatformat:2 }} |
            Balance: ₱{{ balance|floatformat:2 }}
          </div>

          {% if po.status == "BILLING" %}
            <button
              type="button"
              class="btn btn-sm btn-outline-primary"
              id="add-billing-row-btn"
            >
              + Add Billing
            </button>
          {% endif %}
        </div>
      </div>


      <div class="card-body">
        {{ billing_formset.management_form }}
        <template id="billing-empty-form">
          <tr>
            {% for h in billing_formset.empty_form.hidden_fields %}{{ h }}{% endfor %}
            <td><span class="text-muted">Auto</span></td>
            <td>{{ billing_formset.empty_form.check_number }}</td>
            <td class="text-end">{{ billing_formset.empty_form.amount }}</td>
            <td><span class="text-muted">Check Creation</span></td>
          </tr>
        </template>
        <div class="table-responsive">
          <table class="table table-sm align-middle mb-0">
            <thead class="table-light">
              <tr>
                <th style="width:160px;">Billing #</th>
                <th style="width:200px;">Check #</th>
                <th class="text-end" style="width:160px;">Amount</th>
                <th style="width:160px;">Status</th>
              </tr>
            </thead>
            <tbody id="billings-tbody">
              {% for f in billing_formset.forms %}
                {% for h in f.hidden_fields %}{{ h }}{% endfor %}
                <tr class="{% if f.instance.is_cancelled %}table-danger{% endif %}">
                  <td>
                    {% if f.instance.pk %}
                      {{ f.instance.billing_number }}
                    {% else %}
                      <span class="text-muted">Auto</span>
                    {% endif %}
                  </td>
                  <td>{{ f.check_number }}</td>
                  <td class="text-end">{{ f.amount }}</td>
                  <td>
                    <!-- clickable badge for modal -->
                    {% if f.instance.pk %}
                      <button
                        type="button"
                        class="btn btn-sm btn-outline-secondary billing-status-btn"
                        data-billing-id="{{ f.instance.pk }}"
                        data-billing-number="{{ f.instance.billing_number }}"
                        data-status="{{ f.instance.status }}"
                        data-status-label="{{ f.instance.get_status_display }}"
                        data-cancelled="{{ f.instance.is_cancelled|yesno:'1,0' }}"
                      >
                        {{ f.instance.get_status_display }}
                      </button>
                    {% else %}
                      <span class="text-muted">Check Creation</span>
                    {% endif %}
                  </td>
                </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>

        <div class="small text-muted mt-2">
          * BILLING → PO Filing requires: totals match (rounded) AND all billings are PAID.
        </div>
      </div>
    </div>



    <!-- ACTIONS -->
    <div class="d-flex justify-content-end gap-2">
      <button
        type="button"
        class="btn btn-outline-secondary"
        id="discard-btn">
        Discard
      </button>
      {% if can_edit %}
      <button type="submit" name="action" value="save" class="btn btn-primary">
        {% if is_create %}Create RFP{% else %}Save Changes{% endif %}
      </button>
      {% endif %}
      {% if stage == "PO_FILING" %}
      <form method="post" action="{% url 'po-archive' po.id %}" class="d-inline">
          {% csrf_token %}
          <button type="submit" class="btn btn-danger">
              Archive PO
          </button>
      </form>
      {% endif %}
    </div>
    {% if not is_create and po.approval_status == "APPROVED" and stage != "REQUEST_FOR_PAYMENT" and stage != "REQUEST_FOR_PAYMENT_APPROVAL" %}
      <a class="btn btn-outline-dark" href="{% url 'po-print' po.id %}" target="_blank">
        Print PO
      </a>
    {% endif %}


  </form>
</div>  <!-- end right column -->
</div>  <!-- end row -->

  {% if updates %}
  <div class="card mt-4">
    <div class="card-header py-2">
      <strong>Updates</strong>
    </div>
    <div class="card-body">
      <ul class="mb-0">
        {% for u in updates %}
          <li class="mb-2">
            <div class="small text-muted">{{ u.timestamp|date:"Y-m-d H:i" }}</div>
            <div>{{ u.system_update }}</div>
            {% if u.user_notes %}
              <div class="text-muted small">{{ u.user_notes }}</div>
            {% endif %}
          </li>
        {% endfor %}
      </ul>
    </div>
  </div>
  {% endif %}
</div>

<!-- Product ID Quick Add Modal -->
<div class="modal fade" id="productIdModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content shadow-sm">
      <div class="modal-header">
        <h5 class="modal-title">New Product ID</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>

      <div class="modal-body">
        <div class="mb-3">
          <label class="form-label">Product ID Code</label>
          <input
            type="text"
            class="form-control"
            id="product-id-code"
            placeholder="e.g. BSI-HQ-EXPENSES"
            required
          />
        </div>

        <div class="mb-2">
          <label class="form-label">Description (optional)</label>
          <input
            type="text"
            class="form-control"
            id="product-id-desc"
            placeholder="Optional description"
          />
        </div>

        <div
          id="product-id-error"
          class="text-danger small d-none mt-2"
        ></div>
      </div>

      <div class="modal-footer">
        <button
          type="button"
          class="btn btn-outline-secondary"
          data-bs-dismiss="modal"
        >
          Cancel
        </button>
        <button
          type="button"
          class="btn btn-primary"
          id="save-product-id-btn"
        >
          Create Product ID
        </button>
      </div>
    </div>
  </div>
</div>
<!-- Billing Status Modal -->
<div class="modal fade" id="billingStatusModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content shadow-sm">
      <div class="modal-header">
        <h5 class="modal-title">Billing Status</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>

      <div class="modal-body">
        <div class="mb-2">
          <div class="small text-muted">Billing</div>
          <div class="fw-semibold" id="bm-number">—</div>
        </div>

        <div class="mb-3">
          <div class="small text-muted">Current Status</div>
          <div class="fw-semibold" id="bm-status">—</div>
        </div>

        <div class="alert alert-light border small mb-3" id="bm-message">
          Awaiting …
        </div>

        <div class="d-flex gap-2">
          <button
            type="button"
            class="btn btn-primary d-none"
            id="bm-proceed-btn"
          >
            Proceed to Next Status
          </button>

          <button
            type="button"
            class="btn btn-danger d-none"
            id="bm-cancel-btn"
          >
            Cancel Billing
          </button>
        </div>


        <div class="text-danger small mt-2 d-none" id="bm-error"></div>
      </div>
    </div>
  </div>
</div>

{% endblock %}

{% block extra_js %}

<script>
document.addEventListener("DOMContentLoaded", function () {
  const form = document.querySelector("form");
  const discardBtn = document.getElementById("discard-btn");

  if (!form) return;

  let isDirty = false;
  let isSubmitting = false;

  // Capture initial state
  const initialData = new FormData(form);

  function hasFormChanged() {
    const currentData = new FormData(form);
    for (let [key, value] of currentData.entries()) {
      if (initialData.get(key) !== value) {
        return true;
      }
    }
    return false;
  }

  // Track real user changes only
  form.addEventListener("input", () => {
    isDirty = hasFormChanged();
  });

  form.addEventListener("change", () => {
    isDirty = hasFormChanged();
  });

  // SAVE → disable warning
  form.addEventListener("submit", () => {
    isSubmitting = true;
    isDirty = false;
  });

  // Discard button
  if (discardBtn) {
    discardBtn.addEventListener("click", function () {
      if (!hasFormChanged()) {
        window.history.back();
        return;
      }

      const ok = confirm(
        "You have unsaved changes.\n\nIf you leave now, your changes will be lost.\n\nContinue?"
      );

      if (ok) {
        window.history.back();
      }
    });
    window.removeEventListener("beforeunload", beforeUnloadHandler);

  }

  // Browser unload protection
  window.addEventListener("beforeunload", function (e) {
    if (!isDirty || isSubmitting) return;
    e.preventDefault();
    e.returnValue = "";
  });
});
</script>

<script>
const productIdModalEl = document.getElementById("productIdModal");
const productIdModal = new bootstrap.Modal(productIdModalEl);

document.getElementById("add-product-id-btn")?.addEventListener("click", () => {
  // reset modal state
  document.getElementById("product-id-code").value = "";
  document.getElementById("product-id-desc").value = "";
  document.getElementById("product-id-error").classList.add("d-none");

  productIdModal.show();
});

document
  .getElementById("save-product-id-btn")
  ?.addEventListener("click", () => {
    const code = document.getElementById("product-id-code").value.trim();
    const description = document
      .getElementById("product-id-desc")
      .value.trim();

    const errorEl = document.getElementById("product-id-error");

    if (!code) {
      errorEl.textContent = "Product ID code is required.";
      errorEl.classList.remove("d-none");
      return;
    }

    fetch("{% url 'product-id-quick-create' %}", {
      method: "POST",
      headers: {
        "X-CSRFToken": "{{ csrf_token }}",
        "Content-Type": "application/x-www-form-urlencoded",
      },
      body: new URLSearchParams({
        code,
        description,
      }),
    })
      .then(res => res.json())
      .then(data => {
        if (!data.ok) {
          errorEl.textContent =
            data.error || "Failed to create Product ID.";
          errorEl.classList.remove("d-none");
          return;
        }

        const select = document.querySelector(
          "select[name='product_id_ref']"
        );

        const option = document.createElement("option");
        option.value = data.id;
        option.textContent = data.label;
        option.selected = true;

        select.appendChild(option);
        select.dispatchEvent(new Event("change"));

        productIdModal.hide();
      });
  });

function formatPeso(value) {
  return value.toLocaleString("en-PH", {
    minimumFractionDigits: 2,
    maximumFractionDigits: 2,
  });
}

(function () {

  function recalcTotals() {
    let subtotal = 0;

    document.querySelectorAll("tbody tr").forEach(row => {
      const qtyInput = row.querySelector("input[name$='quantity']");
      const priceInput = row.querySelector("input[name$='unit_price']");
      const lineTotalEl = row.querySelector(".line-total");

      const qty = parseFloat(qtyInput?.value) || 0;
      const price = parseFloat(priceInput?.value) || 0;
      const lineTotal = qty * price;

      subtotal += lineTotal;

      if (lineTotalEl) {
        lineTotalEl.textContent = formatPeso(lineTotal);
      }
    });

    const subtotalEl = document.getElementById("po-subtotal");
    if (subtotalEl) {
      subtotalEl.textContent = formatPeso(subtotal);
    }
  }

  // Recalculate on input
  document.addEventListener("input", function (e) {
    if (
      e.target.name?.endsWith("quantity") ||
      e.target.name?.endsWith("unit_price")
    ) {
      recalcTotals();
    }
  });

  // Initial calculation on load (edit mode)
  document.addEventListener("DOMContentLoaded", recalcTotals);

})();
</script>
{% endblock %}

{% block extra_css %}
<style>
  /* Tighten inputs ONLY inside particulars table */
  .particulars-table .form-control {
    padding-left: 0.375rem;   /* tighter than default */
    padding-right: 0.375rem;  /* tighter than default */
  }
  /* PO Lifecycle Sidebar */

.po-lifecycle .completed-step {
    background-color: #f8f9fa; /* muted light gray */
    color: #adb5bd;           /* Bootstrap muted text */
}

.po-lifecycle .completed-step .step-label {
    text-decoration: line-through;
    opacity: 0.6;
}

.po-lifecycle .active-step {
    background-color: #fff3cd; /* Bootstrap warning background */
    color: #664d03;
    font-weight: 600;
}

.po-lifecycle .list-group-item {
    border-left: 4px solid transparent;
}

.po-lifecycle .active-step {
    border-left-color: #ffc107; /* yellow accent */
}

</style>

<script>
function prettyStatus(status) {
  return status
      .replaceAll("_", " ")
      .toLowerCase()
      .replace(/\b\w/g, c => c.toUpperCase());
}

document.addEventListener("DOMContentLoaded", function () {
  const modalEl = document.getElementById("billingStatusModal");
  if (!modalEl) return;

  const modal = new bootstrap.Modal(modalEl);
  const numberEl = document.getElementById("bm-number");
  const statusEl = document.getElementById("bm-status");
  const msgEl = document.getElementById("bm-message");
  const errEl = document.getElementById("bm-error");
  const proceedBtn = document.getElementById("bm-proceed-btn");
  const cancelBtn = document.getElementById("bm-cancel-btn");

  // Role availability: server should render these booleans (we’ll add them in view if you want),
  // but for now we rely on backend enforcing permissions.
  // We still show/hide buttons based on status (and let backend decide final).
  let currentBillingId = null;

  function awaitingText(status){
    // This is purely UI. Backend is authoritative.
    if (status === "CHECK_CREATION") return "Awaiting RVT / Accounting to proceed.";
    if (status === "CHECK_SIGNING") return "Awaiting AGR to proceed.";
    if (status === "PAYMENT_RELEASE") return "Awaiting RVT to mark as Paid.";
    if (status === "PAID") return "Billing is fully paid.";
    return "Awaiting action.";
  }
  const BILLING_STATUS_LABELS = {
    CHECK_CREATION: "Complete Check Creation",
    PAYMENT_RELEASE: "Complete Payment Release",
    PAID: "Mark as Paid",
  };

  document.querySelectorAll(".billing-status-btn").forEach(btn => {
    btn.addEventListener("click", function(){
      errEl.classList.add("d-none");
      errEl.textContent = "";
      proceedBtn.classList.add("d-none");
      cancelBtn.classList.add("d-none");

      currentBillingId = this.dataset.billingId;
      const billingNumber = this.dataset.billingNumber;
      const status = this.dataset.status;
      const statusLabel = this.dataset.statusLabel;
      const cancelled = this.dataset.cancelled === "1";

      numberEl.textContent = billingNumber || "—";
      statusEl.textContent = statusLabel || status || "—";
      msgEl.textContent = cancelled ? "Billing is cancelled." : awaitingText(status);

      if (!cancelled && status !== "PAID") {
        proceedBtn.classList.remove("d-none");
      }

      // Show cancel button always (backend will restrict to RVT)
      if (!cancelled) {
        cancelBtn.classList.remove("d-none");
      }
      // === Dynamic button label ===
      const pretty = prettyStatus(status);
      proceedBtn.textContent = `Complete ${pretty}`;

      // === Show / hide buttons based on status ===
      proceedBtn.classList.toggle(
        "d-none",
        status === "PAID" || status === "CANCELLED"
      );

      cancelBtn.classList.toggle(
        "d-none",
        status === "CANCELLED"
      );

      modal.show();
    });
  });

  proceedBtn?.addEventListener("click", async function(){
    if (!currentBillingId) return;
    errEl.classList.add("d-none");
    try{
      const res = await fetch(`/billing/${currentBillingId}/advance/`, {
        method: "POST",
        headers: { "X-CSRFToken": "{{ csrf_token }}" },
      });
      const data = await res.json();
      if (!data.ok) throw new Error(data.error || "Failed to advance billing.");

      // easiest: reload so badges reflect updated status
      window.location.reload();
    }catch(e){
      errEl.textContent = e.message;
      errEl.classList.remove("d-none");
    }
  });

  cancelBtn?.addEventListener("click", async function(){
    if (!currentBillingId) return;
    if (!confirm("Cancel this billing?")) return;

    errEl.classList.add("d-none");
    try{
      const res = await fetch(`/billing/${currentBillingId}/cancel/`, {
        method: "POST",
        headers: { "X-CSRFToken": "{{ csrf_token }}" },
      });
      const data = await res.json();
      if (!data.ok) throw new Error(data.error || "Failed to cancel billing.");

      window.location.reload();
    }catch(e){
      errEl.textContent = e.message;
      errEl.classList.remove("d-none");
    }
  });
});
</script>
<script>
document.addEventListener("DOMContentLoaded", function () {
  const btn = document.getElementById("add-billing-row-btn");
  if (!btn) return; // button only exists in BILLING stage

  btn.addEventListener("click", function () {
    const totalFormsInput = document.getElementById("id_billings-TOTAL_FORMS");
    const tbody = document.getElementById("billings-tbody");
    const tpl = document.getElementById("billing-empty-form");

    if (!totalFormsInput || !tbody || !tpl) {
      console.error("Billing formset DOM missing:", { totalFormsInput, tbody, tpl });
      return;
    }

    const index = parseInt(totalFormsInput.value || "0", 10);
    const newRow = tpl.innerHTML.replace(/__prefix__/g, index);

    tbody.insertAdjacentHTML("beforeend", newRow);
    totalFormsInput.value = index + 1;
  });
});
</script>

{% endblock %}
